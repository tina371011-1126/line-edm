<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MQ0WMMRZH5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MQ0WMMRZH5');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¾†è‡ªå¥½å‹çš„ç¥ç¦</title>
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; font-family: -apple-system, sans-serif; }
        #mainContainer { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #previewImg { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        .btn-share { position: absolute; bottom: 10%; width: 75%; max-width: 280px; padding: 18px; border-radius: 50px; border: none; background: linear-gradient(135deg, #62be36, #3672d9); color: white; font-size: 18px; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.5); cursor: pointer; display: none; z-index: 10; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #62be36; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* é™¤éŒ¯è¨Šæ¯æ¨£å¼ */
        #errMsg { color: #fff; font-size: 14px; text-align: center; display: none; padding: 20px; background: rgba(255,0,0,0.8); border-radius: 10px; max-width: 90%; word-break: break-all; }
        #debugInfo { font-size: 10px; color: #ccc; margin-top: 10px; text-align: left; }
    </style>
</head>
<body>

    <div id="mainContainer">
        <div id="loader" class="loader"></div>
        <div id="errMsg">
            âš ï¸ é€£çµä¼¼ä¹ä¸å®Œæ•´
            <div id="debugInfo"></div>
        </div>
        <img id="previewImg" alt="æ—©å®‰åœ–">
        <button id="shareBtn" class="btn-share" onclick="doShare()">ğŸ è½‰å‚³é€™ä»½ç¥ç¦</button>
    </div>

<script>
    const CLOUD_NAME = "dwdkxs8ot";

    // ã€æš´åŠ›è§£æã€‘ç›´æ¥æœå°‹æ•´å€‹ç¶²å€å­—ä¸²ï¼Œä¸è«–åƒæ•¸åœ¨å“ªéƒ½æŠ“å‡ºä¾†
    function getParam(name) {
        const currentUrl = window.location.href;
        // é‡å° id å’Œ from_vid åšå…¨åŸŸæœå°‹
        const regex = new RegExp('[?&]' + name + '=([^&#]*)', 'i');
        const match = currentUrl.match(regex);
        
        // å¦‚æœä¸Šé¢æ²’æŠ“åˆ°ï¼Œå˜—è©¦æŠ“ Hash è£¡é¢çš„ (é‡å° LIFF äº‚è·³è½‰)
        if (!match) {
             const hashRegex = new RegExp('#.*[?&]' + name + '=([^&#]*)', 'i');
             const hashMatch = currentUrl.match(hashRegex);
             return hashMatch ? decodeURIComponent(hashMatch[1]) : null;
        }
        
        return match ? decodeURIComponent(match[1]) : null;
    }

    // å–å¾—åƒæ•¸
    const imgId = getParam('id');
    const fromVid = getParam('from_vid') || 'ORIGIN';
    let myVid = localStorage.getItem('v_id');
    if (!myVid) { myVid = 'V-' + Math.random().toString(36).substr(2, 6).toUpperCase(); localStorage.setItem('v_id', myVid); }

    function init() {
        const img = document.getElementById('previewImg');
        const btn = document.getElementById('shareBtn');
        const ld = document.getElementById('loader');
        const err = document.getElementById('errMsg');
        const debug = document.getElementById('debugInfo');

        // å¦‚æœçœŸçš„æŠ“ä¸åˆ° IDï¼Œé¡¯ç¤ºé™¤éŒ¯è³‡è¨Šçµ¦ä½¿ç”¨è€…çœ‹
        if (!imgId || imgId === "undefined" || imgId === "null") {
            ld.style.display = 'none';
            err.style.display = 'block';
            err.innerHTML = `âš ï¸ é€£çµä¸å®Œæ•´<br><br>ç³»çµ±è¨ºæ–·è³‡è¨Š (è«‹æˆªåœ–)ï¼š<br>æ‰¾ä¸åˆ° ID åƒæ•¸<br><br>ç•¶å‰ç¶²å€ï¼š<br>${window.location.href}`;
            return;
        }

        img.src = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/f_auto,q_auto/${imgId}`;

        img.onload = () => {
            ld.style.display = 'none';
            img.style.display = 'block';
            btn.style.display = 'block';
            gtag('event', 'view_card', { 'image_id': imgId, 'visitor_id': myVid, 'from_vid': fromVid });
        };

        img.onerror = () => {
            ld.style.display = 'none';
            err.style.display = 'block';
            err.innerHTML = `âš ï¸ åœ–ç‰‡è®€å–å¤±æ•—<br>ID: ${imgId}`;
        };
    }

    async function doShare() {
        // é‡çµ„ä¹¾æ·¨çš„ç¶²å€
        const cleanPath = window.location.href.split('?')[0].split('#')[0];
        const shareUrl = `${cleanPath}?id=${imgId}&from_vid=${myVid}`;
        
        if (navigator.share) {
            try { await navigator.share({ title: 'æ—©å®‰ç¥ç¦', text: 'é€ä½ ä¸€å¼µç¥ç¦ï¼', url: shareUrl }); } catch (e) {}
        } else {
            const ta = document.createElement("textarea"); ta.value = shareUrl; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); alert("é€£çµå·²è¤‡è£½ï¼");
        }
    }

    init();
</script>
</body>
</html>
