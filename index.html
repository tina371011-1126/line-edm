<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‚¨æ”¶åˆ°ä¸€å€‹æ—©å®‰ç¥ç¦</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        #preview { width: 100%; max-width: 500px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .btn-share { background: #06C755; color: white; padding: 15px 30px; border: none; border-radius: 30px; font-weight: bold; font-size: 18px; cursor: pointer; width: 100%; max-width: 300px; }
    </style>
</head>
<body>
    <h3>ğŸŒ æ—©å®‰åˆ†äº«</h3>
    <canvas id="pc" width="600" height="600" style="display:none;"></canvas>
    <img id="preview" src="" alt="è¼‰å…¥ä¸­...">
    <br>
    <button class="btn-share" onclick="sendShare()">ğŸ“¤ åˆ†äº«çµ¦å¥½å‹</button>

<script>
    const params = new URLSearchParams(window.location.search);
    const bgId = params.get('id') || "10";
    const txt = params.get('t') || "æ—©å®‰";
    const px = parseInt(params.get('x')) || 300;
    const py = parseInt(params.get('y')) || 500;

    async function init() {
        await liff.init({ liffId: "2008941488-Phn5v50S" });
        renderImage();
    }

    function renderImage() {
        const cvs = document.getElementById('pc');
        const ctx = cvs.getContext('2d');
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = `https://picsum.photos/id/${bgId}/600/600`;
        
        img.onload = () => {
            ctx.drawImage(img, 0, 0, 600, 600);
            ctx.font = "bold 40px sans-serif";
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            const w = ctx.measureText(txt).width;
            ctx.fillRect(px - w/2 - 20, py - 30, w + 40, 60);
            ctx.fillStyle = "white"; ctx.textAlign = "center";
            ctx.fillText(txt, px, py + 12);
            
            // å°‡ Canvas è½‰å›åœ–ç‰‡é¡¯ç¤º
            document.getElementById('preview').src = cvs.toDataURL('image/jpeg', 0.8);
        };
    }

    async function sendShare() {
        // å…ˆå°‡ç›®å‰çš„ç•«é¢è½‰ç‚ºåœ–ç‰‡ URL (é€é Imgur è½‰åŒ–ä»¥ä¾› LINE æ°£æ³¡é¡¯ç¤º)
        const blob = await (await fetch(document.getElementById('preview').src)).blob();
        const fd = new FormData(); fd.append("image", blob);
        
        const res = await fetch("https://api.imgur.com/3/image", {
            method: "POST",
            headers: { Authorization: "Client-ID 5300f283832d734" },
            body: fd
        });
        const d = await res.json();
        const finalImg = d.data.link;

        if (liff.isApiAvailable('shareTargetPicker')) {
            await liff.shareTargetPicker([{
                "type": "flex",
                "altText": "æ‚¨æ”¶åˆ°ä¸€å€‹æ—©å®‰ç¥ç¦",
                "contents": {
                  "type": "bubble",
                  "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      { "type": "image", "url": finalImg, "size": "full", "aspectMode": "cover", "aspectRatio": "1:1" }
                    ],
                    "paddingAll": "0px"
                  },
                  "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      { "type": "button", "action": { "type": "uri", "label": "æˆ‘ä¹Ÿè¦è£½ä½œ", "uri": `line://app/2008941488-Phn5v50S` }, "style": "primary", "color": "#06C755" }
                    ]
                  }
                }
            }]);
        }
    }

    init();
</script>
</body>
</html>
