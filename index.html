<script>
    const LIFF_ID = "2008941488-Phn5v50S";
    let finalImageUrl = "";
    let finalRatio = "1:1";

    async function initLiff() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }

            const url = new URL(window.location.href);
            const params = url.searchParams;
            const hashParams = new URLSearchParams(url.hash.substring(1));
            
            // 優先從參數讀取圖片、寬、高
            const imgParam = params.get('img') || hashParams.get('img');
            const w = params.get('w') || hashParams.get('w');
            const h = params.get('h') || hashParams.get('h');

            finalImageUrl = imgParam ? decodeURIComponent(imgParam) : "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_wEmp9REFby6o2cCIVgnzgnQP8OLqNMwEpg&s";

            // --- 優化核心：如果網址已有寬高，直接顯示按鈕，不等待下載 ---
            if (w && h) {
                finalRatio = `${w}:${h}`;
                showActionBtn("預覽已就緒");
            } else {
                // 備援方案：若網址無寬高參數，才走舊的下載偵測邏輯
                const img = new Image();
                img.onload = () => {
                    finalRatio = `${img.width}:${img.height}`;
                    showActionBtn("預覽已就緒");
                };
                img.src = finalImageUrl;
            }

            // 非同步執行 GA 追蹤，不阻礙 UI
            gtag('event', 'liff_open', { 'image_url': finalImageUrl });

        } catch (e) { console.error(e); }
    }

    function showActionBtn(msg) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('actionBtn').style.display = 'inline-block';
        document.getElementById('msg').innerText = msg;
    }

    // async function handleShare() {
            if (liff.isApiAvailable('shareTargetPicker')) {
                try {
                    const result = await liff.shareTargetPicker([{
                        "type": "flex",
                        "altText": "您收到一張圖片",
                        "contents": {
                            "type": "bubble",
                            "size": "mega", 
                            "body": {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [{
                                    "type": "image",
                                    "url": finalImageUrl,
                                    "size": "full",
                                    "aspectMode": "fit", 
                                    "aspectRatio": finalRatio,
                                    "action": {
                                        "type": "uri",
                                        "uri": `https://liff.line.me/${LIFF_ID}/?img=${encodeURIComponent(finalImageUrl)}`
                                    }
                                }],
                                "paddingAll": "0px"
                            }
                        }
                    }]);

                    if (result) {
                        // 2. 核心追蹤：當使用者按下發送並成功關閉視窗時觸發
                        gtag('event', 'edm_share_success', {
                            'method': 'shareTargetPicker',
                            'image_url': finalImageUrl
                        });
                        
                        document.getElementById('msg').innerText = "發送成功！";
                        setTimeout(() => liff.closeWindow(), 800);
                    }
                } catch (error) { console.error(error); }
            }
        }
</script>
