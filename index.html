<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©å®‰ç¥ç¦</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        #pv { width: 100%; max-width: 500px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn { background: #06C755; color: white; padding: 15px 30px; border: none; border-radius: 30px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 20px; width: 80%; }
        #ld { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 99; }
    </style>
</head>
<body>
    <div id="ld">ğŸš€ æ­£åœ¨é‚„åŸæ—©å®‰ç¥ç¦...</div>
    <h3>ğŸŒ æ”¶åˆ°ä¸€ä»½ç¥ç¦</h3>
    <canvas id="pc" width="600" height="600" style="display:none;"></canvas>
    <img id="pv" src="">
    <button class="btn" id="sbtn" onclick="sendShare()">ğŸ“¤ è½‰å‚³é€™ä»½ç¥ç¦</button>

<script>
    const params = new URLSearchParams(window.location.search);
    const bgId = params.get('id') || "10", txt = params.get('t') || "æ—©å®‰", px = parseInt(params.get('x')) || 300, py = parseInt(params.get('y')) || 520;

    async function init() {
        await liff.init({ liffId: "2008941488-Phn5v50S" });
        const cvs = document.getElementById('pc'), ctx = cvs.getContext('2d'), img = new Image();
        img.crossOrigin = "anonymous";
        img.src = `https://picsum.photos/id/${bgId}/600/600`;
        img.onload = () => {
            ctx.drawImage(img, 0, 0, 600, 600);
            ctx.font = "bold 42px sans-serif";
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            const w = ctx.measureText(txt).width;
            ctx.fillRect(px - w/2 - 20, py - 35, w + 40, 70);
            ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(txt, px, py);
            document.getElementById('pv').src = cvs.toDataURL('image/jpeg', 0.8);
            document.getElementById('ld').style.display = 'none';
        };
    }

    async function sendShare() {
        const sbtn = document.getElementById('sbtn');
        sbtn.innerText = "â³ è™•ç†ä¸­...";
        try {
            // 1. å°‡åœ–ç‰‡å‚³è‡³ Imgur ä½œç‚ºæ°£æ³¡åœ–æº
            const blob = await (await fetch(document.getElementById('pv').src)).blob();
            const fd = new FormData(); fd.append("image", blob);
            const res = await fetch("https://api.imgur.com/3/image", {
                method: "POST",
                headers: { Authorization: "Client-ID 5300f283832d734" },
                body: fd
            });
            const d = await res.json();
            const imgUrl = d.data.link;

            // 2. å‘¼å«åˆ†äº«è¦–çª—
            if (liff.isApiAvailable('shareTargetPicker')) {
                await liff.shareTargetPicker([{
                    "type": "flex",
                    "altText": "é€ä½ ä¸€å¼µæ—©å®‰ç¥ç¦åœ–",
                    "contents": {
                        "type": "bubble",
                        "body": { "type": "box", "layout": "vertical", "paddingAll": "0px", "contents": [
                            { "type": "image", "url": imgUrl, "size": "full", "aspectRatio": "1:1", "aspectMode": "cover" }
                        ]},
                        "footer": { "type": "box", "layout": "vertical", "contents": [
                            { "type": "button", "action": { "type": "uri", "label": "æˆ‘ä¹Ÿè¦è£½ä½œ", "uri": "line://app/2008941488-Phn5v50S" }, "style": "primary", "color": "#3672d9" }
                        ]}
                    }
                }]);
            }
        } catch (e) { alert("è½‰å‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); }
        sbtn.innerText = "ğŸ“¤ è½‰å‚³é€™ä»½ç¥ç¦";
    }
    init();
</script>
</body>
</html>
