<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MQ0WMMRZH5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MQ0WMMRZH5');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¾†è‡ªå¥½å‹çš„ç¥ç¦</title>
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; font-family: -apple-system, sans-serif; }
        #mainContainer { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        /* åœ–ç‰‡è‡ªé©æ‡‰å…¨è¢å¹• */
        #previewImg { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        
        /* è½‰å‚³æŒ‰éˆ•æ¨£å¼ */
        .btn-share { position: absolute; bottom: 10%; width: 75%; max-width: 280px; padding: 18px; border-radius: 50px; border: none; background: linear-gradient(135deg, #62be36, #3672d9); color: white; font-size: 18px; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.5); cursor: pointer; display: none; z-index: 10; -webkit-tap-highlight-color: transparent; }
        .btn-share:active { transform: scale(0.95); opacity: 0.9; }

        /* è¼‰å…¥ä¸­å‹•ç•« */
        .loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #62be36; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #errMsg { color: #888; font-size: 14px; text-align: center; display: none; padding: 20px; }
    </style>
</head>
<body>

    <div id="mainContainer">
        <div id="loader" class="loader"></div>
        <div id="errMsg">âš ï¸ é€£çµä¼¼ä¹ä¸å®Œæ•´ï¼Œè«‹å‘å¥½å‹é‡æ–°ç´¢å–</div>
        <img id="previewImg" alt="æ—©å®‰åœ–">
        <button id="shareBtn" class="btn-share" onclick="doShare()">ğŸ è½‰å‚³é€™ä»½ç¥ç¦</button>
    </div>

<script>
    const CLOUD_NAME = "dwdkxs8ot";

    // ã€æ ¸å¿ƒä¿®æ­£ï¼šè¬èƒ½åƒæ•¸æŠ“å–å™¨ã€‘é‡å° LINE LIFF è·³è½‰å„ªåŒ–
    function getUrlParam(name) {
        const url = window.location.href;
        // æŠ“å–åŒ…å« ? æˆ– # å¾Œé¢çš„åƒæ•¸ï¼Œé˜²æ­¢ LIFF æŠŠåƒæ•¸å¡é€² Hash
        const results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(url);
        if (!results) return null;
        return decodeURIComponent(results[1]) || null;
    }

    const imgId = getUrlParam('id');
    const fromVid = getUrlParam('from_vid') || 'ORIGIN';
    
    // ç”Ÿæˆ/ç²å–ç•¶å‰è¨ªå•è€…çš„åŒ¿å ID
    let myVid = localStorage.getItem('v_id');
    if (!myVid) {
        myVid = 'V-' + Math.random().toString(36).substr(2, 6).toUpperCase();
        localStorage.setItem('v_id', myVid);
    }

    function init() {
        const img = document.getElementById('previewImg');
        const btn = document.getElementById('shareBtn');
        const ld = document.getElementById('loader');
        const err = document.getElementById('errMsg');

        if (!imgId) {
            ld.style.display = 'none';
            err.style.display = 'block';
            console.error("Missing Image ID");
            return;
        }

        // ä½¿ç”¨ Cloudinary è‡ªå‹•å„ªåŒ–æ ¼å¼èˆ‡å“è³ª (f_auto, q_auto)
        img.src = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/f_auto,q_auto/${imgId}`;

        img.onload = () => {
            ld.style.display = 'none';
            img.style.display = 'block';
            btn.style.display = 'block';
            
            // GA4 è¿½è¹¤ï¼šæˆåŠŸçœ‹åœ–
            gtag('event', 'view_card', {
                'image_id': imgId,
                'visitor_id': myVid,
                'from_vid': fromVid
            });
        };

        img.onerror = () => {
            ld.style.display = 'none';
            err.innerText = "åœ–ç‰‡å·²å¤±æ•ˆæˆ–é€£çµéŒ¯èª¤";
            err.style.display = 'block';
        };
    }

    // åˆ†äº«åŠŸèƒ½
    async function doShare() {
        const shareUrl = `${window.location.origin}${window.location.pathname}?id=${imgId}&from_vid=${myVid}`;
        
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'æ—©å®‰ç¥ç¦',
                    text: 'é€ä½ ä¸€å¼µæˆ‘ç‚ºä½ è£½ä½œçš„æ—©å®‰ç¥ç¦ï¼',
                    url: shareUrl
                });
                gtag('event', 'card_reshare_success', { 'image_id': imgId, 'vid': myVid });
            } catch (e) {
                console.log("Share cancelled or failed");
            }
        } else {
            // ä¸æ”¯æ´ Web Share API å‰‡è¤‡è£½åˆ°å‰ªè²¼ç°¿
            const ta = document.createElement("textarea");
            ta.value = `é€ä½ ä¸€å¼µæ—©å®‰ç¥ç¦åœ–ï¼š${shareUrl}`;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            alert("é€£çµå·²è¤‡è£½ï¼Œå¿«å»è²¼çµ¦å¥½å‹ï¼");
        }
    }

    init();
</script>
</body>
</html>
