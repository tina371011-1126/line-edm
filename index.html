<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>早安祝福</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MQ0WMMRZH5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MQ0WMMRZH5', {
          'custom_map': { 'dimension1': 'from_sid', 'dimension2': 'my_vid' }
      });
    </script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; display: flex; flex-direction: column; overflow: hidden; font-family: sans-serif; }
        #previewContainer { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        #previewImg { max-width: 95%; max-height: 95%; object-fit: contain; opacity: 0; transition: opacity 0.5s ease; border-radius: 8px; }
        .ui-overlay { position: relative; width: 100%; padding: 20px; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; box-sizing: border-box; }
        .btn { border: none; padding: 16px; font-size: 18px; border-radius: 50px; font-weight: bold; width: 100%; max-width: 320px; color: white; background: linear-gradient(90deg, #d4c84a 0%, #62be36 50%, #3672d9 100%); cursor: pointer; text-align: center; text-decoration: none; }
        #msg { color: #ccc; font-size: 14px; margin-bottom: 15px; }
        .loader { position: absolute; border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #62be36; border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="previewContainer">
        <div id="loader" class="loader"></div>
        <img id="previewImg" src="">
    </div>
    <div class="ui-overlay">
        <div id="msg">正在加載好友的祝福...</div>
        <button id="actionBtn" class="btn" style="display:none;" onclick="doNativeShare()">我也要轉傳祝福</button>
    </div>

<script>
    const CLOUD_NAME = "dwdkxs8ot";
    const LIFF_ID = "2008941488-Phn5v50S";

    // 1. 產生一個隨機的 Visitor ID 用於追蹤 (不需 LINE 授權)
    let myVid = localStorage.getItem('user_vid');
    if (!myVid) {
        myVid = 'V' + Math.random().toString(36).substr(2, 9).toUpperCase();
        localStorage.setItem('user_vid', myVid);
    }

    function getParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    const imgId = getParam('id');
    const fromSid = getParam('sid') || 'origin';

    function init() {
        if (imgId) {
            const img = document.getElementById('previewImg');
            img.src = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/f_auto,q_auto/${imgId}`;
            img.onload = () => {
                img.style.opacity = '1';
                document.getElementById('loader').style.display = 'none';
                document.getElementById('actionBtn').style.display = 'block';
                document.getElementById('msg').innerText = "點擊按鈕分享祝福給朋友";
            };

            // GA 追蹤：誰(myVid) 看了 誰(fromSid) 傳的圖
            gtag('event', 'view_edm_no_auth', {
                'image_id': imgId,
                'from_sid': fromSid,
                'my_vid': myVid
            });
        }
    }

    async function doNativeShare() {
        // 構造下一層連結，將我的 Vid 傳下去變成下一層的 sid
        const shareUrl = `https://liff.line.me/${LIFF_ID}/?id=${imgId}&sid=${myVid}`;
        const shareText = `送你一張早安祝福！點開查看：`;

        // GA 追蹤：點擊分享動作
        gtag('event', 'click_share_no_auth', {
            'image_id': imgId,
            'from_sid': fromSid,
            'my_vid': myVid
        });

        // 優先使用手機原生分享 (Android/iOS)
        if (navigator.share) {
            try {
                await navigator.share({
                    title: '早安祝福',
                    text: shareText,
                    url: shareUrl
                });
            } catch (err) { console.log("User cancelled"); }
        } else {
            // 不支援原生分享時 (如 PC)，直接導向 LINE 文字轉發
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(shareText + "\n" + shareUrl)}`;
            window.location.href = lineUrl;
        }
    }

    init();
</script>
</body>
</html>
