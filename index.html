<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¾†è‡ªå¥½å‹çš„ç¥ç¦</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MQ0WMMRZH5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MQ0WMMRZH5');
    </script>
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; font-family: -apple-system, sans-serif; }
        #mainContainer { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        /* åœ–ç‰‡å®¹å™¨ï¼šä¿è­‰åœ–ç‰‡åœ¨ä¸­é–“ä¸”ä¸è®Šå½¢ */
        #previewImg { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            display: none; /* è¼‰å…¥å®Œæˆå‰éš±è— */
        }
        
        .btn-share { position: absolute; bottom: 8%; width: 70%; max-width: 280px; padding: 15px; border-radius: 50px; border: none; background: #06c755; color: white; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; display: none; z-index: 100; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: #06c755; border-radius: 50%; animation: spin 1s linear infinite; position: absolute; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #errorInfo { color: #fff; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; display: none; text-align: center; max-width: 80%; }
    </style>
</head>
<body>

    <div id="mainContainer">
        <div id="loader" class="loader"></div>
        
        <img id="previewImg" alt="æ—©å®‰åœ–">
        
        <div id="errorInfo">
            <p>åœ–ç‰‡è¼‰å…¥ä¸­...</p>
            <small id="debugText" style="color:#aaa; font-size:10px;"></small>
        </div>

        <button id="shareBtn" class="btn-share" onclick="doShare()">ğŸ è½‰å‚³é€™å¼µåœ–</button>
    </div>

<script>
    const CLOUD_NAME = "dwdkxs8ot"; // ä½ çš„ Cloudinary åç¨±
    
    // ã€çµ‚æ¥µç¶²å€è§£æã€‘
    function getParam(name) {
        const url = window.location.href;
        // 1. å˜—è©¦æŠ“å–æ¨™æº–åƒæ•¸ (?id=...)
        let regex = new RegExp('[?&]' + name + '=([^&#]*)', 'i');
        let results = regex.exec(url);
        
        // 2. å¦‚æœæ²’æŠ“åˆ°ï¼Œå˜—è©¦æŠ“å– Hash ä¸­çš„åƒæ•¸ (é‡å° index.html#/?id=...)
        if (!results) {
            regex = new RegExp('#.*[?&]' + name + '=([^&#]*)', 'i');
            results = regex.exec(url);
        }

        return results ? decodeURIComponent(results[1]) : null;
    }

    const imgId = getParam('id');
    const fromVid = getParam('from_vid') || 'ORIGIN';
    
    // åˆå§‹åŒ–è¨ªå®¢ ID
    let myVid = localStorage.getItem('v_id');
    if (!myVid) { 
        myVid = 'V-' + Math.random().toString(36).substr(2, 6).toUpperCase(); 
        localStorage.setItem('v_id', myVid); 
    }

    function init() {
        const img = document.getElementById('previewImg');
        const loader = document.getElementById('loader');
        const errDiv = document.getElementById('errorInfo');
        const debugText = document.getElementById('debugText');
        const btn = document.getElementById('shareBtn');

        // å¦‚æœçœŸçš„æ²’æœ‰ IDï¼Œé¡¯ç¤ºæç¤º
        if (!imgId) {
            loader.style.display = 'none';
            errDiv.style.display = 'block';
            errDiv.querySelector('p').innerText = "é€£çµä¼¼ä¹ä¸å®Œæ•´ (ID éºå¤±)";
            debugText.innerText = "ç›®å‰çš„ç¶²å€: " + window.location.href;
            return;
        }

        // è¨­å®šåœ–ç‰‡ç¶²å€ (åŠ å…¥ Cloudinary å„ªåŒ–åƒæ•¸)
        img.src = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/f_auto,q_auto/${imgId}`;

        img.onload = () => {
            loader.style.display = 'none';
            img.style.display = 'block';
            btn.style.display = 'block';
            
            // åªæœ‰æˆåŠŸè¼‰å…¥æ‰ç™¼é€ GA æ•¸æ“š
            gtag('event', 'view_card', {
                'image_id': imgId,
                'visitor_id': myVid,
                'from_vid': fromVid
            });
        };

        img.onerror = () => {
            loader.style.display = 'none';
            errDiv.style.display = 'block';
            errDiv.querySelector('p').innerText = "åœ–ç‰‡å·²éæœŸæˆ–ç„¡æ³•è®€å–";
        };
    }

    async function doShare() {
        // ç”¢ç”Ÿä¹¾æ·¨çš„åˆ†äº«é€£çµï¼Œç¢ºä¿ä¸‹æ¬¡åˆ†äº«ä¹Ÿæ˜¯å°çš„
        // é€™è£¡æˆ‘å€‘æ‰‹å‹•æ‹¼æ¹Šæ­£ç¢ºçš„è·¯å¾‘ï¼Œé¿å…å› ç‚ºç€è¦½å™¨è·³è½‰å°è‡´è·¯å¾‘æ··äº‚
        const cleanBase = window.location.href.split('?')[0].split('#')[0];
        // ç¢ºä¿çµå°¾æ˜¯ index.html
        let fixedBase = cleanBase;
        if (!fixedBase.endsWith('index.html')) {
            if (fixedBase.endsWith('/')) fixedBase += 'index.html';
            else fixedBase += '/index.html';
        }

        const shareUrl = `${fixedBase}?id=${imgId}&from_vid=${myVid}`;
        
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'æ—©å®‰ç¥ç¦',
                    text: 'é€ä½ ä¸€å¼µæˆ‘è¦ªæ‰‹åšçš„ç¥ç¦åœ–ï¼',
                    url: shareUrl
                });
            } catch (e) { console.log("åˆ†äº«å–æ¶ˆ"); }
        } else {
            prompt("è«‹è¤‡è£½ä¸‹æ–¹é€£çµå‚³çµ¦å¥½å‹ï¼š", shareUrl);
        }
    }

    // å•Ÿå‹•ç¨‹å¼
    init();
</script>
</body>
</html>
