<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MQ0WMMRZH5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MQ0WMMRZH5');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¥½å‹çš„ç¥ç¦</title>
    <style>
        body, html { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; display:flex; align-items:center; justify-content:center; }
        #mainContainer { position:relative; width:100vw; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #previewImg { max-width:100%; max-height:100%; object-fit:contain; display:none; }
        .btn-share { position:absolute; bottom:10%; width:80%; max-width:300px; padding:18px; border-radius:50px; border:none; background:linear-gradient(135deg, #62be36, #3672d9); color:white; font-size:18px; font-weight:bold; box-shadow:0 10px 20px rgba(0,0,0,0.4); display:none; cursor:pointer; }
        .loading { width:40px; height:40px; border:4px solid rgba(255,255,255,0.2); border-top-color:#62be36; border-radius:50%; animation:s 1s linear infinite; }
        @keyframes s { to { transform:rotate(360deg); } }
        #debug { color:#555; font-size:10px; position:absolute; bottom:5px; }
    </style>
</head>
<body>
    <div id="mainContainer">
        <div id="loader" class="loading"></div>
        <img id="previewImg">
        <button class="btn-share" id="shareBtn" onclick="doShare()">ğŸ è½‰å‚³é€™ä»½ç¥ç¦</button>
        <div id="debug"></div>
    </div>

<script>
    const CLOUD_NAME = "dwdkxs8ot";

    // ã€è¬èƒ½è§£æå™¨ã€‘é˜²æ­¢ LIFF çš„å¤šé‡è·³è½‰æä¸Ÿåƒæ•¸
    function findParam(name) {
        // 1. å¾æ¨™æº– QueryString æ‰¾
        let val = new URLSearchParams(window.location.search).get(name);
        if (val) return val;
        // 2. å¾ Hash æ‰¾ (LIFF ç¶“å¸¸æŠŠåƒæ•¸æ”¾é€™)
        val = new URLSearchParams(window.location.hash.split('?')[1]).get(name);
        if (val) return val;
        // 3. å¾å®Œæ•´ URL å¼·åˆ¶æ­£å‰‡åŒ¹é…
        const reg = new RegExp("[?&]" + name + "=([^&#]*)", "i");
        const res = window.location.href.match(reg);
        return res ? res[1] : null;
    }

    const imgId = findParam('id');
    const fromVid = findParam('from_vid') || 'ORIGIN';

    function getMyVid() {
        let vid = localStorage.getItem('v_id') || ('V-' + Math.random().toString(36).substr(2, 6).toUpperCase());
        localStorage.setItem('v_id', vid);
        return vid;
    }
    const myVid = getMyVid();

    function init() {
        const img = document.getElementById('previewImg');
        const btn = document.getElementById('shareBtn');
        const ld = document.getElementById('loader');

        if (!imgId) {
            ld.style.display = 'none';
            document.getElementById('debug').innerText = "Missing ID - URL: " + window.location.href;
            return;
        }

        img.onload = () => { ld.style.display='none'; img.style.display='block'; btn.style.display='block'; };
        img.onerror = () => { ld.style.display='none'; alert("åœ–ç‰‡åŠ è¼‰å¤±æ•—"); };
        img.src = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/f_auto,q_auto/${imgId}`;

        gtag('event', 'card_receive', { 'visitor_id': myVid, 'from_vid': fromVid, 'image_id': imgId });
    }

    async function doShare() {
        const url = `${window.location.origin}${window.location.pathname}?id=${imgId}&from_vid=${myVid}`;
        if (navigator.share) {
            try {
                await navigator.share({ title: 'å¥½å‹é€ä½ ç¥ç¦', text: 'é»é–‹çœ‹åœ–', url: url });
                gtag('event', 'card_re_share', { 'sharer': myVid });
            } catch (e) {}
        } else {
            navigator.clipboard.writeText(url);
            alert("é€£çµå·²è¤‡è£½ï¼");
        }
    }
    init();
</script>
</body>
</html>
