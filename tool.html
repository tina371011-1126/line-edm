// --- è«‹ç¢ºä¿é€™äº›å…¨åŸŸè®Šæ•¸å·²å®šç¾© ---
const CLOUD_NAME = "dwdkxs8ot";
const UPLOAD_PRESET = "morning picture";
const LIFF_ID = "2008941488-Phn5v50S"; 

/**
 * æ ¸å¿ƒç”¢ç”Ÿå‡½æ•¸ï¼šè™•ç†ä¸Šå‚³ã€ç”Ÿæˆé€£çµã€è¤‡è£½åˆ°å‰ªè²¼ç°¿
 */
async function fastGenerate() {
    const btn = document.getElementById('genBtn');
    if (!btn) return;
    
    // 1. é˜²æ­¢é‡è¤‡é»æ“Š
    btn.disabled = true;
    btn.innerText = "â³ è™•ç†ä¸­...";

    // 2. è™•ç†è¨ªå®¢ ID (v_id)
    let myVid = localStorage.getItem('v_id');
    if (!myVid) {
        myVid = 'U-' + Math.random().toString(36).substr(2, 6).toUpperCase();
        localStorage.setItem('v_id', myVid);
    }

    try {
        // 3. å°‡ Canvas è½‰ç‚º Base64
        const canvas = document.getElementById('mainCanvas'); // è«‹ç¢ºèªä½ çš„ Canvas ID æ˜¯é€™å€‹
        if (!canvas) throw new Error("æ‰¾ä¸åˆ°ç•«å¸ƒ");
        
        const base64 = canvas.toDataURL('image/jpeg', 0.8);
        const fd = new FormData();
        fd.append("file", base64);
        fd.append("upload_preset", UPLOAD_PRESET);

        // 4. ä¸Šå‚³è‡³ Cloudinary
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
            method: "POST",
            body: fd
        });
        const data = await res.json();

        if (data.public_id) {
            // 5. ã€é—œéµä¿®æ­£ã€‘æ§‹å»ºé€£çµ
            // ä½¿ç”¨ ? ç›´æ¥æ¥åœ¨ LIFF ID å¾Œé¢ï¼Œä¸¦ç¢ºä¿åƒæ•¸è¢«å®Œå…¨ç·¨ç¢¼
            const shareUrl = `https://liff.line.me/${LIFF_ID}?id=${encodeURIComponent(data.public_id)}&from_vid=${myVid}`;

            const finalMsg = `ğŸ”” é€ä½ ä¸€å¼µæ—©å®‰ç¥ç¦ï¼š${shareUrl}`;
            
            // å¯«å…¥éš±è—æ¬„ä½ä¾›å¾ŒçºŒä½¿ç”¨
            const hiddenInput = document.getElementById('hiddenText');
            if (hiddenInput) hiddenInput.value = finalMsg;

            // 6. GA4 äº‹ä»¶è¿½è¹¤
            if (typeof gtag === 'function') {
                gtag('event', 'share_generated', {
                    'image_id': data.public_id,
                    'vid': myVid
                });
            }

            // 7. è¤‡è£½åˆ°å‰ªè²¼ç°¿
            const success = await copyToClipboard(finalMsg);
            
            if (success) {
                const successEl = document.getElementById('successMsg');
                if (successEl) successEl.style.display = 'block';
                btn.innerText = "âœ¨ é€£çµå·²è¤‡è£½";
            } else {
                const manualEl = document.getElementById('manualArea');
                if (manualEl) manualEl.style.display = 'block';
                btn.innerText = "âœ… ç”Ÿæˆå®Œæˆ";
            }
        } else {
            throw new Error(data.error ? data.error.message : "ä¸Šå‚³å¤±æ•—");
        }
    } catch (e) {
        console.error("Debug Error:", e);
        alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– Cloudinary è¨­å®š");
        btn.innerText = "âŒ å¤±æ•—ï¼Œé‡è©¦";
    } finally {
        btn.disabled = false;
    }
}

/**
 * è¼”åŠ©å‡½æ•¸ï¼šè¤‡è£½æ–‡å­—åˆ°å‰ªè²¼ç°¿ (ç›¸å®¹æ€§å¢å¼·ç‰ˆ)
 */
async function copyToClipboard(text) {
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            return true;
        } else {
            // å‚™ç”¨æ–¹æ¡ˆï¼šå‚³çµ± execCommand å¯«æ³•
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            return successful;
        }
    } catch (err) {
        return false;
    }
}
