<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—©å®‰åœ–ç”¢ç”Ÿå™¨ v9</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { color: #2c3e50; text-align: center; font-size: 22px; margin-bottom: 15px; }
        
        /* ç•«å¸ƒé è¦½å€ */
        .preview-container { position: relative; width: 100%; aspect-ratio: 1/1; background: #eee; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 2px solid #ddd; }
        #mainCanvas { width: 100%; height: 100%; display: block; }
        
        .input-group { margin-bottom: 15px; }
        label { font-size: 13px; color: #666; font-weight: bold; display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 15px; }
        
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button { border: none; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 14px; }
        
        .btn-random { background: #6c5ce7; color: white; }
        .btn-gen { background: linear-gradient(90deg, #d4c84a 0%, #62be36 50%, #3672d9 100%); color: white; grid-column: span 2; font-size: 16px; box-shadow: 0 4px 15px rgba(54, 114, 217, 0.3); }
        .btn-share { background: #06C755; color: white; width: 100%; display: none; margin-top: 10px; font-size: 16px; }
        
        button:active { transform: scale(0.95); opacity: 0.8; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }

        .result-area { margin-top: 20px; display: none; border-top: 1px dashed #ddd; padding-top: 15px; }
        .link-box { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; word-break: break-all; font-size: 12px; font-family: monospace; margin-top: 5px; position: relative; }
        .loader { text-align: center; font-size: 13px; color: #62be36; display: none; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>â˜€ï¸ æ—©å®‰åœ– AI ç”¢ç”Ÿå™¨</h2>
    
    <div class="preview-container">
        <canvas id="mainCanvas" width="800" height="800"></canvas>
    </div>

    <div class="input-group">
        <label>æ—©å®‰å•å€™èª (è‡ªå‹•åŒæ­¥åˆ°åœ–ä¸­)</label>
        <input type="text" id="morningText" placeholder="ä¾‹å¦‚ï¼šæ—©å®‰ï¼ç¥ä½ æœ‰ç¾å¥½çš„ä¸€å¤©" value="æ—©å®‰ï¼å¹³å®‰å–œæ¨‚">
    </div>

    <div class="button-grid">
        <button class="btn-random" onclick="fetchRandomImage()">ğŸ”„ éš¨æ©Ÿ AI èƒŒæ™¯</button>
        <button class="btn-gen" id="finalBtn" onclick="processAndUpload()">âœ¨ å°è£ä¸¦ç”¢ç”Ÿåˆ†äº«é€£çµ</button>
    </div>

    <div id="loading" class="loader">ğŸš€ æ­£åœ¨è™•ç†åœ–ç‰‡ä¸¦ç”Ÿæˆé€£çµ...</div>

    <div id="resultArea" class="result-area">
        <button id="shareBtn" class="btn-share" onclick="directShare()">ğŸ“¤ ç«‹å³ç™¼é€åˆ° LINE ç¾¤çµ„</button>
        <label style="margin-top:15px;">Deep Link (é»æ“Šåœ–ç‰‡å³é–‹å•Ÿ):</label>
        <div class="link-box" id="finalLink">---</div>
    </div>
</div>

<script>
    const LIFF_ID = "2008941488-Phn5v50S"; // æ‚¨çš„ LIFF ID
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('morningText');
    let currentBaseImage = new Image();

    // åˆå§‹åŒ–ï¼šé è¨­è¼‰å…¥ä¸€å¼µæº«é¦¨èƒŒæ™¯
    async function init() {
        await liff.init({ liffId: LIFF_ID });
        fetchRandomImage();
        
        // ç›£è½æ–‡å­—è¼¸å…¥ï¼Œå³æ™‚é‡ç¹ª
        textInput.addEventListener('input', drawAll);
    }

    // 1. å–å¾—éš¨æ©Ÿå•†ç”¨ AI é¢¨æ ¼åœ– (Unsplash)
    function fetchRandomImage() {
        const keywords = ['nature', 'morning', 'sunrise', 'flowers', 'zen'];
        const randomKey = keywords[Math.floor(Math.random() * keywords.length)];
        const imgUrl = `https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80&sig=${Math.random()}`; 
        
        // é€™è£¡ç‚ºäº†ç©©å®šï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å¼µé«˜è³ªé‡çš„é¢¨æ™¯åœ–ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ›æˆå…¶ä»–çš„ API
        const randomImgUrl = `https://source.unsplash.com/800x800/?${randomKey},morning`;
        
        currentBaseImage.crossOrigin = "anonymous"; // å¿…é ˆé–‹å•Ÿæ‰èƒ½å°å‡ºåœ–ç‰‡
        currentBaseImage.src = `https://images.weserv.nl/?url=${encodeURIComponent(randomImgUrl)}&w=800&h=800&fit=cover`; // ä½¿ç”¨ä»£ç†é¿å… CORS
        
        currentBaseImage.onload = () => {
            drawAll();
        };
    }

    // 2. ç¹ªè£½åœ–ç‰‡èˆ‡æ–‡å­—
    function drawAll() {
        // ç•«èƒŒæ™¯
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(currentBaseImage, 0, 0, 800, 800);
        
        // ç•«ä¸ŠåŠé€æ˜é®ç½© (è®“æ–‡å­—æ¸…æ¥š)
        ctx.fillStyle = "rgba(0, 0, 0, 0.25)";
        ctx.fillRect(0, 600, 800, 200);

        // ç•«æ–‡å­—
        const text = textInput.value || "æ—©å®‰ï¼å¹³å®‰å–œæ¨‚";
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 10;
        
        // å­—é«”é©é…
        ctx.font = "bold 50px -apple-system, sans-serif";
        ctx.fillText(text, 400, 720);
    }

    // 3. è™•ç†ã€ä¸Šå‚³ä¸¦ç”¢ç”Ÿé€£çµ
    async function processAndUpload() {
        const btn = document.getElementById('finalBtn');
        const loader = document.getElementById('loading');
        btn.disabled = true;
        loader.style.display = 'block';

        try {
            // å°‡ Canvas è½‰ç‚º Blob
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
            
            // ä¸Šå‚³è‡³ ImgBB (å…è²» API)
            const formData = new FormData();
            formData.append("image", blob);
            
            // ä½¿ç”¨å…¬å…±æ¸¬è©¦ Key (å»ºè­°æ›æˆæ‚¨è‡ªå·±çš„ ImgBB API Key ä»¥ä¿è­‰ç©©å®š)
            const uploadRes = await fetch("https://api.imgbb.com/1/upload?key=67503f56860d70928929944122d733e1", {
                method: "POST",
                body: formData
            });
            const uploadData = await uploadRes.json();
            const finalImgUrl = uploadData.data.url;

            // ç¸®çŸ­é€£çµ (é¿å… Deep Link éé•·)
            const shortImgUrl = await getShortUrl(finalImgUrl);

            // ç”¢ç”Ÿæœ€çµ‚ Deep Link (line://app/)
            const deepLink = `line://app/${LIFF_ID}/?i=${encodeURIComponent(shortImgUrl)}&w=800&h=800&f=AI_Generator`;

            window.currentShareData = {
                url: shortImgUrl,
                link: deepLink
            };

            document.getElementById('finalLink').innerText = deepLink;
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('shareBtn').style.display = 'block';
            loader.style.display = 'none';
        } catch (e) {
            alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }

    async function getShortUrl(longUrl) {
        try {
            const api = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`;
            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(api)}`);
            const data = await response.json();
            return data.shorturl || longUrl;
        } catch (e) { return longUrl; }
    }

    async function directShare() {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        
        try {
            const res = await liff.shareTargetPicker([{
                "type": "flex",
                "altText": "é€ä½ ä¸€å¼µæ—©å®‰åœ–",
                "contents": {
                    "type": "bubble", "size": "mega",
                    "body": {
                        "type": "box", "layout": "vertical", "paddingAll": "0px",
                        "contents": [{
                            "type": "image", "url": window.currentShareData.url, "size": "full", 
                            "aspectMode": "fit", "aspectRatio": "1:1",
                            "action": { "type": "uri", "uri": window.currentShareData.link }
                        }]
                    }
                }
            }]);
            if (res) alert("å·²æˆåŠŸç™¼é€ï¼");
        } catch (e) { alert("åˆ†äº«å¤±æ•—"); }
    }

    init();
</script>

</body>
</html>
