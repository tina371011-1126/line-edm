<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ—©å®‰åœ–ç·¨è¼¯ç”¢ç”Ÿå™¨</title>
    <style>
        :root { --primary: linear-gradient(90deg, #d4c84a 0%, #62be36 50%, #3672d9 100%); }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; box-sizing: border-box; }
        
        /* ç•«å¸ƒç·¨è¼¯å€ï¼šä¿®æ­£é¡¯ç¤ºå•é¡Œ */
        #canvasContainer { 
            position: relative; 
            margin: 15px auto; 
            background: #333; 
            border-radius: 8px; 
            overflow: hidden; 
            touch-action: none; 
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas { width: 100%; height: 100%; object-fit: contain; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 14px; }
        
        .sticker-box { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; margin-bottom: 10px; border-top: 1px solid #eee; white-space: nowrap; }
        .sticker-item { font-size: 28px; cursor: pointer; background: #f8f9fa; padding: 8px; border-radius: 10px; min-width: 45px; display: inline-block; text-align: center; border: 1px solid #eee; }

        button { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin: 5px 0; font-size: 16px; }
        .btn-secondary { background: #555; font-size: 14px; }
        
        .result-area { display: none; background: #e8f0fe; padding: 15px; border-radius: 10px; margin-top: 15px; word-break: break-all; border: 2px dashed #3672d9; }
        #finalLiffUrl { font-size: 12px; background: white; padding: 10px; border-radius: 5px; margin: 10px 0; display: block; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color: #3672d9; margin-bottom: 5px;">ğŸš€ æ—©å®‰åœ–ç”¢ç”Ÿå™¨</h2>
    <p style="font-size: 13px; color: #777; margin-bottom: 15px;">ç·¨è¼¯æ–‡å­—èˆ‡è²¼åœ–ï¼Œä¸€éµè½‰å‚³ Line</p>

    <div id="canvasContainer">
        <canvas id="editorCanvas" width="800" height="800"></canvas>
    </div>

    <div class="controls">
        <button class="btn-secondary" onclick="fetchRandomImage()">ğŸ”„ æ›å¼µéš¨æ©Ÿåœ–</button>
        <button class="btn-secondary" onclick="resetElements()">ğŸ—‘ï¸ å…¨éƒ¨é‡ç½®</button>
        <input type="text" id="textInput" placeholder="è¼¸å…¥æ–‡å­—..." oninput="draw()">
        <input type="color" id="colorPicker" value="#ffffff" onchange="draw()">
    </div>

    <div class="sticker-box">
        <div class="sticker-item" onclick="addSticker('â˜€ï¸')">â˜€ï¸</div>
        <div class="sticker-item" onclick="addSticker('ğŸŒ¸')">ğŸŒ¸</div>
        <div class="sticker-item" onclick="addSticker('â˜•')">â˜•</div>
        <div class="sticker-item" onclick="addSticker('ğŸ€')">ğŸ€</div>
        <div class="sticker-item" onclick="addSticker('ğŸŒ¹')">ğŸŒ¹</div>
        <div class="sticker-item" onclick="addSticker('ğŸ˜Š')">ğŸ˜Š</div>
        <div class="sticker-item" onclick="addSticker('ğŸ™')">ğŸ™</div>
    </div>

    <button id="genBtn" onclick="uploadAndGenerate()">âœ¨ ç”¢ç”Ÿä¸¦è¤‡è£½åˆ†äº«é€£çµ</button>

    <div id="resultArea" class="result-area">
        <strong style="color:#222">ğŸ‰ è£½ä½œå®Œæˆï¼</strong>
        <span id="finalLiffUrl">é€£çµç”¢ç”Ÿä¸­...</span>
        <button onclick="copyLink()">ğŸ“‹ è¤‡è£½ç™¼é€åˆ° LINE</button>
    </div>
</div>

<script>
    const LIFF_ID = "2008941488-Phn5v50S";
    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');
    let bgImg = new Image();
    // é è¨­ä¸»æ–‡å­—
    let elements = [{ type: 'text', x: 400, y: 700, size: 50 }];
    let isDragging = false;
    let selectedElement = null;

    // ä¿®æ­£ 1ï¼šæ”¹ç”¨ç©©å®šçš„åœ–åº«ä¸¦å¼·åˆ¶è¨­å®š crossOrigin
    function fetchRandomImage() {
        document.getElementById('genBtn').disabled = true;
        document.getElementById('genBtn').innerText = "åœ–ç‰‡è®€å–ä¸­...";
        
        const randomId = Math.floor(Math.random() * 1000);
        const newImg = new Image();
        newImg.crossOrigin = "anonymous"; 
        // ä½¿ç”¨ Lorem Picsum ç”¢å‡ºè‡ªç„¶é¢¨æ™¯é¡çš„åœ–
        newImg.src = `https://picsum.photos/800/800?random=${randomId}`;
        
        newImg.onload = () => {
            bgImg = newImg;
            draw();
            document.getElementById('genBtn').disabled = false;
            document.getElementById('genBtn').innerText = "âœ¨ ç”¢ç”Ÿä¸¦è¤‡è£½åˆ†äº«é€£çµ";
        };
        newImg.onerror = () => alert("åœ–åº«é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦");
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ç¹ªè£½èƒŒæ™¯
        if (bgImg.complete) {
            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
        }

        // ç¹ªè£½æ‰€æœ‰å…ƒç´ 
        const mainText = document.getElementById('textInput').value || "æ—©å®‰ï¼Œç¥ä½ æœ‰ç¾å¥½çš„ä¸€å¤©";
        const mainColor = document.getElementById('colorPicker').value;

        elements.forEach((el, index) => {
            ctx.textAlign = "center";
            if (el.type === 'text') {
                ctx.fillStyle = mainColor;
                ctx.font = `bold ${el.size}px "Microsoft JhengHei", sans-serif`;
                ctx.strokeStyle = "rgba(0,0,0,0.7)";
                ctx.lineWidth = 6;
                ctx.strokeText(mainText, el.x, el.y);
                ctx.fillText(mainText, el.x, el.y);
            } else if (el.type === 'sticker') {
                ctx.font = `${el.size}px serif`;
                ctx.fillText(el.text, el.x, el.y);
            }
        });
    }

    function addSticker(emoji) {
        elements.push({ type: 'sticker', x: 400, y: 400, text: emoji, size: 80 });
        draw();
    }

    function resetElements() {
        elements = [elements[0]];
        document.getElementById('textInput').value = "";
        draw();
    }

    // ä¿®æ­£ 2ï¼šæ”¹é€²æ‰‹æ©Ÿè§¸æ§æ‹–æ‹‰é‚è¼¯
    function handleStart(e) {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        const x = (clientX - rect.left) * (canvas.width / rect.width);
        const y = (clientY - rect.top) * (canvas.height / rect.height);

        selectedElement = [...elements].reverse().find(el => 
            Math.abs(el.x - x) < 60 && Math.abs(el.y - y) < 60
        );
        if (selectedElement) isDragging = true;
    }

    function handleMove(e) {
        if (!isDragging || !selectedElement) return;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        selectedElement.x = (clientX - rect.left) * (canvas.width / rect.width);
        selectedElement.y = (clientY - rect.top) * (canvas.height / rect.height);
        draw();
    }

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('touchstart', handleStart, {passive: false});
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('touchmove', handleMove, {passive: false});
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('touchend', () => isDragging = false);

    // ä¿®æ­£ 3ï¼šä¸Šå‚³èˆ‡é€£çµç”¢ç”Ÿ
    async function uploadAndGenerate() {
        const btn = document.getElementById('genBtn');
        btn.disabled = true;
        btn.innerText = "ğŸš€ æ­£åœ¨åˆæˆåœ–ç‰‡...";

        try {
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
            const formData = new FormData();
            formData.append('image', blob);

            // ä½¿ç”¨ Imgur API ä¸Šå‚³
            const res = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: { Authorization: 'Client-ID 7f33887d163353e' },
                body: formData
            });
            const json = await res.json();
            if (!json.success) throw new Error("ä¸Šå‚³å¤±æ•—");

            const finalImgUrl = json.data.link;
            const liffUrl = `https://liff.line.me/${LIFF_ID}/?i=${encodeURIComponent(finalImgUrl)}&w=800&h=800&f=AI`;
            
            document.getElementById('finalLiffUrl').innerText = liffUrl;
            document.getElementById('resultArea').style.display = 'block';
            btn.innerText = "âœ¨ ç”¢ç”Ÿå®Œæˆ";
        } catch (e) {
            alert("éŒ¯èª¤: " + e.message);
            btn.disabled = false;
            btn.innerText = "âœ¨ ç”¢ç”Ÿä¸¦è¤‡è£½åˆ†äº«é€£çµ";
        }
    }

    function copyLink() {
        const url = document.getElementById('finalLiffUrl').innerText;
        navigator.clipboard.writeText(`â˜€ï¸é€æ‚¨ä¸€å¼µæ—©å®‰ç¥ç¦ï¼š\n${url}`).then(() => alert("å·²è¤‡è£½ï¼å»è²¼çµ¦å¥½å‹å§ï¼"));
    }

    fetchRandomImage();
</script>
</body>
</html>
