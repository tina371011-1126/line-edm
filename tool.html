<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ—©å®‰åœ–é€£çµç”¢ç”Ÿå™¨</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --accent: #3672d9; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: #f3f5f7; margin: 0; padding: 15px; display: flex; justify-content: center; overflow-x: hidden; }
        .card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 450px; box-sizing: border-box; }
        
        /* ç•«å¸ƒå€ */
        .preview-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #333; border-radius: 16px; overflow: hidden; margin-bottom: 15px; touch-action: none; border: 2px solid #eee; }
        #mainCanvas { width: 100%; height: 100%; display: block; cursor: move; }
        
        .control-label { font-size: 14px; font-weight: bold; color: #444; margin: 12px 0 8px; display: block; }
        .input-row { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; }
        input[type="color"] { width: 50px; height: 48px; border: none; background: none; cursor: pointer; padding: 0; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        button { border: none; padding: 14px; border-radius: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 15px; }
        .btn-refresh { background: #e1e5ea; color: #333; }
        .btn-confirm { background: linear-gradient(135deg, #62be36, #3672d9); color: white; }
        
        /* è¤‡è£½æ–‡æ¡ˆå€ */
        .result-area { margin-top: 20px; border-top: 2px dashed #eee; padding-top: 15px; display: none; }
        .copy-box { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; position: relative; }
        .copy-text { font-size: 14px; color: #333; word-break: break-all; margin-bottom: 10px; line-height: 1.5; white-space: pre-wrap; }
        .btn-copy { background: #555; color: white; width: 100%; font-size: 14px; padding: 10px; }
        .btn-share { background: var(--line-green); color: white; width: 100%; margin-top: 10px; font-size: 16px; }
        
        #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display:none; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .error-msg { color: #d9534f; font-size: 13px; text-align: center; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="text-align: center; margin: 0 0 15px;">ğŸ¨ AI æ—©å®‰åœ–ç”¢ç”Ÿå™¨</h3>
    
    <div class="preview-box">
        <div id="loader"></div>
        <canvas id="mainCanvas" width="800" height="800"></canvas>
    </div>

    <div class="input-row">
        <input type="text" id="txt" value="æ—©å®‰ï¼Œå¹³å®‰å–œæ¨‚" maxlength="20">
        <input type="color" id="clr" value="#ffffff">
    </div>

    <div class="btn-grid">
        <button class="btn-refresh" onclick="loadImg()">ğŸ”„ æ›å€‹èƒŒæ™¯</button>
        <button class="btn-confirm" id="genBtn" onclick="handleUpload()">âœ¨ ç”¢ç”Ÿé€£çµ</button>
    </div>

    <div id="errorBox" class="error-msg">âŒ ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦ä¸€æ¬¡ã€‚</div>

    <div class="result-area" id="resultArea">
        <label class="control-label">ğŸ“‹ è¤‡è£½ä¸‹æ–¹æ–‡æ¡ˆç™¼é€ï¼š</label>
        <div class="copy-box">
            <div class="copy-text" id="finalCopyText"></div>
            <button class="btn-copy" onclick="copyToClipboard()">ğŸ“Œ é»æ“Šè¤‡è£½æ–‡æ¡ˆ</button>
            <button class="btn-share" onclick="shareToLine()">ğŸ“¤ ç›´æ¥å‚³é€å¥½å‹</button>
        </div>
    </div>
</div>

<script>
    // --- è«‹å¡«å…¥æ‚¨çš„è³‡è¨Š ---
    const UNSPLASH_KEY = "YOUR_ACCESS_KEY"; // è‹¥æ²’å¡«æœƒè·‘æ¸¬è©¦åœ–æº
    const LIFF_ID = "2008941488-Phn5v50S"; 
    
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let bgImg = new Image();
    let textPos = { x: 400, y: 700 };
    let isDragging = false;

    async function init() {
        try { await liff.init({ liffId: LIFF_ID }); } catch(e) {}
        loadImg();
        document.getElementById('txt').oninput = draw;
        document.getElementById('clr').oninput = draw;
        
        // æ‹–æ›³é‚è¼¯
        canvas.addEventListener('mousedown', (e) => isDragging = true);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); isDragging = true; }, {passive: false});
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('touchend', () => isDragging = false);
    }

    function handleMove(e) {
        if(!isDragging) return;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        textPos.x = (clientX - rect.left) * (800 / rect.width);
        textPos.y = (clientY - rect.top) * (800 / rect.height);
        draw();
    }

    async function loadImg() {
        document.getElementById('loader').style.display = 'block';
        let url = `https://loremflickr.com/800/800/morning,nature?t=${Date.now()}`;
        
        if (UNSPLASH_KEY !== "YOUR_ACCESS_KEY") {
            try {
                const res = await fetch(`https://api.unsplash.com/photos/random?query=morning&client_id=${UNSPLASH_KEY}`);
                const data = await res.json();
                url = data.urls.regular;
            } catch(e) { console.log("Using Fallback Img"); }
        }

        bgImg = new Image();
        bgImg.crossOrigin = "Anonymous";
        bgImg.src = `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=800&h=800&fit=cover`;
        bgImg.onload = () => { draw(); document.getElementById('loader').style.display = 'none'; };
    }

    function draw() {
        ctx.clearRect(0,0,800,800);
        ctx.drawImage(bgImg, 0, 0, 800, 800);
        
        const text = document.getElementById('txt').value;
        ctx.font = "bold 55px 'Microsoft JhengHei'";
        const tw = ctx.measureText(text).width;
        
        ctx.fillStyle = "rgba(0,0,0,0.4)";
        ctx.fillRect(textPos.x - tw/2 - 20, textPos.y - 45, tw + 40, 90);
        
        ctx.fillStyle = document.getElementById('clr').value;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, textPos.x, textPos.y);
    }

    async function handleUpload() {
        const btn = document.getElementById('genBtn');
        const err = document.getElementById('errorBox');
        btn.disabled = true;
        err.style.display = 'none';

        try {
            const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
            const formData = new FormData();
            formData.append("file", blob);

            const res = await fetch("https://telegra.ph/upload", { method: "POST", body: formData });
            const data = await res.json();
            
            if(!data[0]) throw new Error();
            const imgUrl = "https://telegra.ph" + data[0].src;
            const deepLink = `line://app/${LIFF_ID}/?i=${encodeURIComponent(imgUrl)}&w=800&h=800&f=EDM`;

            // è¨­å®šæ–‡æ¡ˆæ ¼å¼ (ğŸ”” æ ¼å¼)
            const copyContent = `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${deepLink}`;
            document.getElementById('finalCopyText').innerText = copyContent;
            document.getElementById('resultArea').style.display = 'block';
            window.shareData = { img: imgUrl, link: deepLink, text: copyContent };
            
            // è‡ªå‹•æ»¾å‹•åˆ°çµæœ
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        } catch (e) {
            err.style.display = 'block';
        } finally {
            btn.disabled = false;
        }
    }

    function copyToClipboard() {
        const text = document.getElementById('finalCopyText').innerText;
        navigator.clipboard.writeText(text).then(() => alert("æ–‡æ¡ˆå·²è¤‡è£½ï¼"));
    }

    async function shareToLine() {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        await liff.shareTargetPicker([{
            "type": "flex", "altText": "é€ä½ ä¸€å¼µæ—©å®‰åœ–",
            "contents": {
                "type": "bubble", "body": {
                    "type": "box", "layout": "vertical", "paddingAll": "0px",
                    "contents": [{
                        "type": "image", "url": window.shareData.img, "size": "full", "aspectRatio": "1:1",
                        "action": { "type": "uri", "uri": window.shareData.link }
                    }]
                }
            }
        }]);
    }

    init();
</script>
</body>
</html>
