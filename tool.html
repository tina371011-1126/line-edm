<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å•†ç”¨æ—©å®‰åœ–å·¥å…·</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --main: #06C755; --bg: #f5f7fa; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 440px; }
        
        /* ç•«å¸ƒå€å¡Š */
        .cvs-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 12px; touch-action: none; }
        #mc { width: 100%; height: 100%; display: block; }
        #ld { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; font-size: 14px; display: none; z-index: 10; }

        /* æ§åˆ¶åˆ— */
        .row { display: flex; gap: 8px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
        input[type="color"] { width: 45px; height: 48px; border: none; background: none; cursor: pointer; }

        /* è²¼åœ–åˆ— */
        .stk-bar { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; margin-bottom: 12px; -webkit-overflow-scrolling: touch; }
        .stk { font-size: 24px; padding: 8px; background: #f0f0f0; border-radius: 10px; cursor: pointer; flex-shrink: 0; border: 2px solid transparent; }
        .stk.active { border-color: var(--main); background: #e8f9ed; }

        /* æŒ‰éˆ•çµ„ */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .b-grey { background: #eee; color: #333; }
        .b-blue { background: #3672d9; color: white; }
        .b-main { background: var(--main); color: white; grid-column: span 2; padding: 15px; font-size: 16px; margin-top: 10px; }
        
        /* çµæœå€ */
        .res-area { margin-top: 15px; background: #fff9e6; border: 1px solid #ffeeba; border-radius: 12px; padding: 15px; display: none; }
        .copy-text { font-size: 13px; color: #856404; word-break: break-all; white-space: pre-wrap; margin-bottom: 10px; line-height: 1.5; }
        .b-copy { background: #555; color: white; width: 100%; }
        
        .err { color: #d9534f; text-align: center; font-size: 13px; margin-top: 8px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <div class="cvs-box">
        <div id="ld">ğŸš€ è™•ç†ä¸­...</div>
        <canvas id="mc" width="800" height="800"></canvas>
    </div>

    <div class="row">
        <input type="text" id="itxt" value="æ—©å®‰ï¼Œç”Ÿæ´»å……æ»¿å–œæ‚…" maxlength="20">
        <input type="color" id="iclr" value="#ffffff">
    </div>

    <div class="stk-bar">
        <div class="stk active" data-v="">ğŸš« ç„¡</div>
        <div class="stk" data-v="â˜€ï¸">â˜€ï¸</div>
        <div class="stk" data-v="ğŸŒ¸">ğŸŒ¸</div>
        <div class="stk" data-v="â˜•">â˜•</div>
        <div class="stk" data-v="ğŸ€">ğŸ€</div>
        <div class="stk" data-v="ğŸŒˆ">ğŸŒˆ</div>
        <div class="stk" data-v="ğŸ±">ğŸ±</div>
    </div>

    <div class="btn-grid">
        <button class="b-grey" onclick="getImg()">ğŸ”„ æ›èƒŒæ™¯</button>
        <button class="b-grey" onclick="resetItems()">ğŸ¯ é‡ç½®ä½ç½®</button>
        <button class="b-blue" onclick="uploadImg()">âœ¨ ç”¢ç”Ÿæ–‡æ¡ˆ</button>
        <button class="b-main" onclick="shareToLine()">ğŸ“¤ åˆ†äº«çµ¦å¥½å‹ (LIFF)</button>
    </div>

    <div id="eb" class="err">âŒ ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦ä¸€æ¬¡</div>

    <div class="res-area" id="rb">
        <div class="copy-text" id="ct"></div>
        <button class="b-copy" onclick="copyText()">ğŸ“Œ è¤‡è£½æ—©å®‰åœ–é€£çµæ–‡æ¡ˆ</button>
    </div>
</div>

<script>
    // å·²å¡«å…¥æ‚¨çš„ Access Key
    const KEY = "UgZ1pLt9-I5t6BMM71gGBCWZHQk_3oXxYA4uhrHgsVw"; 
    const LIFF_ID = "2008941488-Phn5v50S"; 

    const cvs = document.getElementById('mc'), ctx = cvs.getContext('2d');
    let img = new Image();
    let items = [
        { id: 'txt', x: 400, y: 700 },
        { id: 'stk', x: 720, y: 100, v: '' }
    ];
    let activeItem = null;

    async function init() {
        try { await liff.init({ liffId: LIFF_ID }); } catch(e){}
        getImg();
        document.getElementById('itxt').oninput = draw;
        document.getElementById('iclr').oninput = draw;
        
        document.querySelectorAll('.stk').forEach(s => {
            s.onclick = () => {
                document.querySelectorAll('.stk').forEach(i => i.classList.remove('active'));
                s.classList.add('active');
                items[1].v = s.dataset.v;
                draw();
            };
        });

        // è‡ªç”±æ‹–æ›³é‚è¼¯
        const start = (e) => {
            const p = getP(e);
            if(items[1].v && Math.hypot(p.x-items[1].x, p.y-items[1].y) < 80) activeItem = items[1];
            else if(Math.abs(p.x-items[0].x) < 300 && Math.abs(p.y-items[0].y) < 60) activeItem = items[0];
        };
        const move = (e) => {
            if(!activeItem) return;
            const p = getP(e); activeItem.x = p.x; activeItem.y = p.y; draw();
        };
        cvs.addEventListener('mousedown', start);
        cvs.addEventListener('touchstart', e => { e.preventDefault(); start(e); }, {passive:false});
        window.addEventListener('mousemove', move);
        window.addEventListener('touchmove', e => { if(activeItem) e.preventDefault(); move(e); }, {passive:false});
        window.addEventListener('mouseup', () => activeItem = null);
        window.addEventListener('touchend', () => activeItem = null);
    }

    function getP(e) {
        const r = cvs.getBoundingClientRect(), t = e.touches ? e.touches[0] : e;
        return { x: (t.clientX - r.left) * (800/r.width), y: (t.clientY - r.top) * (800/r.height) };
    }

    function resetItems() {
        items[0].x = 400; items[0].y = 700;
        items[1].x = 720; items[1].y = 100;
        draw();
    }

    async function getImg() {
        document.getElementById('ld').style.display = 'block';
        // ä½¿ç”¨æ‚¨çš„ Key æŠ“å– Unsplash åœ–ç‰‡ï¼Œä¸¦ä½¿ç”¨ä»£ç†ä¼ºæœå™¨è£åˆ‡æ‰é‚Šç·£
        const res = await fetch(`https://api.unsplash.com/photos/random?query=morning,nature&client_id=${KEY}`);
        const data = await res.json();
        const rawUrl = data.urls.regular;

        img = new Image();
        img.crossOrigin = "anonymous";
        // w=880 & fit=cover è‡ªå‹•ç§»é™¤é‚Šç·£ 40px ä»¥ç¢ºä¿ç„¡æµ®æ°´å°
        img.src = `https://images.weserv.nl/?url=${encodeURIComponent(rawUrl)}&w=880&h=880&fit=cover&a=center`;
        img.onload = () => { draw(); document.getElementById('ld').style.display = 'none'; };
    }

    function draw() {
        // èƒŒæ™¯è£åˆ‡ç¹ªè£½ï¼Œå®Œç¾å»æ°´å°
        ctx.drawImage(img, -40, -40, 880, 880); 
        
        // ç¹ªè£½è²¼åœ– (å¦‚æœæœ‰é¸çš„è©±)
        if(items[1].v) {
            ctx.font = "120px serif"; ctx.textAlign = "center";
            ctx.fillText(items[1].v, items[1].x, items[1].y);
        }

        // ç¹ªè£½æ–‡å­—èˆ‡èƒŒæ¿
        const val = document.getElementById('itxt').value, clr = document.getElementById('iclr').value;
        ctx.font = "bold 52px 'Microsoft JhengHei', sans-serif";
        const tw = ctx.measureText(val).width;
        ctx.fillStyle = "rgba(0,0,0,0.4)";
        ctx.fillRect(items[0].x - tw/2 - 25, items[0].y - 45, tw + 50, 95);
        ctx.fillStyle = clr;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(val, items[0].x, items[0].y + 5);
    }

    async function uploadImg() {
        document.getElementById('ld').style.display = 'block';
        document.getElementById('eb').style.display = 'none';
        try {
            const blob = await new Promise(r => cvs.toBlob(r, 'image/jpeg', 0.8));
            const fd = new FormData(); fd.append("file", blob);
            const res = await fetch("https://telegra.ph/upload", { method: "POST", body: fd });
            const d = await res.json();
            const url = "https://telegra.ph" + d[0].src;
            const lnk = `line://app/${LIFF_ID}/?i=${encodeURIComponent(url)}&w=800&h=800&f=EDM`;
            
            window.lastResult = { u: url, l: lnk, text: `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${lnk}` };
            document.getElementById('ct').innerText = window.lastResult.text;
            document.getElementById('rb').style.display = 'block';
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        } catch(e) { document.getElementById('eb').style.display = 'block'; }
        finally { document.getElementById('ld').style.display = 'none'; }
    }

    function copyText() {
        navigator.clipboard.writeText(window.lastResult.text).then(() => alert("ğŸ”” æ–‡æ¡ˆå·²è¤‡è£½ï¼å¯ä»¥è²¼åˆ°ç¾¤çµ„äº†"));
    }

    async function shareToLine() {
        if(!window.lastResult) { await uploadImg(); }
        await liff.shareTargetPicker([{
            "type": "flex", "altText": "é€ä½ ä¸€å¼µæ—©å®‰åœ–å¡",
            "contents": { "type": "bubble", "body": { "type": "box", "layout": "vertical", "paddingAll": "0px",
                "contents": [{ "type": "image", "url": window.lastResult.u, "size": "full", "aspectRatio": "1:1",
                    "action": { "type": "uri", "uri": window.lastResult.l } }] } }
        }]);
    }
    init();
</script>
</body>
</html>
