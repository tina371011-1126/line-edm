<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å•†ç”¨æ—©å®‰åœ–ç”¢ç”Ÿå™¨ v12</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line: #06C755; --bg: #f8f9fb; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; overscroll-behavior-y: contain; }
        .card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        
        .preview-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 16px; overflow: hidden; margin-bottom: 15px; border: 2px solid #eee; touch-action: none; }
        #mainCanvas { width: 100%; height: 100%; cursor: crosshair; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; }
        input[type="color"] { width: 50px; height: 50px; border: none; background: none; cursor: pointer; }
        
        .btn-stack { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { border: none; padding: 15px; border-radius: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-ref { background: #f0f0f0; color: #333; }
        .btn-gen { background: linear-gradient(135deg, #62be36, #3672d9); color: white; }
        
        /* çµæœæ–‡æ¡ˆå€ */
        .result-box { margin-top: 20px; border-top: 2px dashed #eee; padding-top: 20px; display: none; }
        .copy-area { background: #f1f3f5; padding: 15px; border-radius: 12px; font-size: 14px; color: #333; word-break: break-all; margin-bottom: 10px; white-space: pre-wrap; line-height: 1.6; }
        .btn-copy { background: #444; color: white; width: 100%; margin-bottom: 8px; }
        .btn-share { background: var(--line); color: white; width: 100%; font-size: 16px; }

        #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .error { color: #d9534f; font-size: 13px; text-align: center; margin-top: 10px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="text-align:center; margin:0 0 15px;">ğŸ¨ å•†ç”¨ AI åœ–å¡å·¥å…·</h3>
    
    <div class="preview-box">
        <div id="loader"></div>
        <canvas id="mainCanvas" width="800" height="800"></canvas>
    </div>

    <div class="input-group">
        <input type="text" id="txt" value="æ—©å®‰ï¼Œç”Ÿæ´»å……æ»¿é™½å…‰" maxlength="20">
        <input type="color" id="clr" value="#ffffff">
    </div>

    <div class="btn-stack">
        <button class="btn-ref" onclick="fetchImg()">ğŸ”„ æ›èƒŒæ™¯</button>
        <button class="btn-gen" id="genBtn" onclick="processOutput()">âœ¨ ç”¢ç”Ÿåˆ†äº«é€£çµ</button>
    </div>

    <div id="errMsg" class="error">âŒ ç”¢ç”Ÿå¤±æ•—ï¼Œå¯èƒ½æ˜¯ç¶²è·¯ä¸ç©©æˆ–åœ–åºŠå¿™ç¢Œä¸­</div>

    <div class="result-box" id="resultBox">
        <div class="copy-area" id="copyContent"></div>
        <button class="btn-copy" onclick="copyText()">ğŸ“Œ è¤‡è£½ EDM æ–‡æ¡ˆ</button>
        <button class="btn-share" onclick="shareLine()">ğŸ“¤ ç›´æ¥åˆ†äº«åˆ°ç¾¤çµ„</button>
    </div>
</div>

<script>
    const LIFF_ID = "2008941488-Phn5v50S";
    const UNSPLASH_KEY = "YOUR_ACCESS_KEY"; // è«‹å¡«å…¥æ­£ç¢º Key
    
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let bg = new Image();
    let txtPos = { x: 400, y: 680 };
    let isMoving = false;

    async function init() {
        try { await liff.init({ liffId: LIFF_ID }); } catch(e) {}
        fetchImg();
        document.getElementById('txt').oninput = render;
        document.getElementById('clr').oninput = render;
        
        // è‡ªç”±æ‹–æ›³
        canvas.addEventListener('mousedown', () => isMoving = true);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); isMoving = true; }, {passive: false});
        window.addEventListener('mousemove', move);
        window.addEventListener('touchmove', move, {passive: false});
        window.addEventListener('mouseup', () => isMoving = false);
        window.addEventListener('touchend', () => isMoving = false);
    }

    function move(e) {
        if(!isMoving) return;
        const r = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        txtPos.x = (cx - r.left) * (800 / r.width);
        txtPos.y = (cy - r.top) * (800 / r.height);
        render();
    }

    async function fetchImg() {
        document.getElementById('loader').style.display = 'block';
        // ä½¿ç”¨æ›´ä¹¾æ·¨çš„ Sourceï¼Œä¸¦åŠ å…¥ç¨å¾®æ”¾å¤§(Zoom)é‚è¼¯ä¾†åˆ‡é™¤æ½›åœ¨é‚Šç·£æµ®æ°´å°
        let url = `https://loremflickr.com/900/900/nature,calm?t=${Date.now()}`;
        
        bg = new Image();
        bg.crossOrigin = "Anonymous";
        // é€é weserv ä»£ç†ä¸¦å¼·åˆ¶è£åˆ‡ä¸­å¤®ï¼Œé¿é–‹é‚Šç·£ç°½å
        bg.src = `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=800&h=800&fit=cover&a=center`;
        bg.onload = () => { render(); document.getElementById('loader').style.display = 'none'; };
    }

    function render() {
        ctx.clearRect(0,0,800,800);
        // ç¹ªè£½èƒŒæ™¯ (è‡ªå‹•è£åˆ‡é‚Šç·£ä»¥ç§»é™¤æµ®æ°´å°)
        ctx.drawImage(bg, 0, 0, 800, 800);
        
        const t = document.getElementById('txt').value;
        ctx.font = "bold 52px 'Microsoft JhengHei'";
        const w = ctx.measureText(t).width;
        
        // æ–‡å­—èƒŒæ¿
        ctx.fillStyle = "rgba(0,0,0,0.45)";
        ctx.roundRect ? ctx.fillRoundRect(txtPos.x - w/2 - 25, txtPos.y - 45, w + 50, 90, 15) : ctx.fillRect(txtPos.x - w/2 - 25, txtPos.y - 45, w + 50, 90);
        ctx.fill();

        ctx.fillStyle = document.getElementById('clr').value;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 10;
        ctx.fillText(t, txtPos.x, txtPos.y);
    }

    async function processOutput() {
        const btn = document.getElementById('genBtn');
        const err = document.getElementById('errMsg');
        btn.disabled = true;
        err.style.display = 'none';

        try {
            // å„ªåŒ– Blob è½‰æ›
            const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
            const fd = new FormData();
            fd.append("file", blob);

            // æ”¹è‰¯çš„ä¸Šå‚³è«‹æ±‚
            const res = await fetch("https://telegra.ph/upload", { method: "POST", body: fd });
            const data = await res.json();
            
            if(!data[0] || !data[0].src) throw new Error("Upload Failed");
            
            const imgUrl = "https://telegra.ph" + data[0].src;
            const link = `line://app/${LIFF_ID}/?i=${encodeURIComponent(imgUrl)}&w=800&h=800&f=EDM`;

            // è¨­å®šğŸ””æ–‡æ¡ˆæ ¼å¼
            const fullText = `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${link}`;
            document.getElementById('copyContent').innerText = fullText;
            document.getElementById('resultBox').style.display = 'block';
            window.finalData = { img: imgUrl, link: link, copy: fullText };
            
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        } catch (e) {
            err.style.display = 'block';
        } finally {
            btn.disabled = false;
        }
    }

    function copyText() {
        navigator.clipboard.writeText(window.finalData.copy).then(() => alert("ğŸ”” æ–‡æ¡ˆå·²æˆåŠŸè¤‡è£½ï¼"));
    }

    async function shareLine() {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        await liff.shareTargetPicker([{
            "type": "flex", "altText": "é€ä½ ä¸€å¼µæ—©å®‰åœ–å¡",
            "contents": {
                "type": "bubble", "body": {
                    "type": "box", "layout": "vertical", "paddingAll": "0px",
                    "contents": [{
                        "type": "image", "url": window.finalData.img, "size": "full", "aspectRatio": "1:1",
                        "action": { "type": "uri", "uri": window.finalData.link }
                    }]
                }
            }
        }]);
    }

    init();
</script>
</body>
</html>
