<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ—©å®‰åœ–è£½ä½œ - ç„¡é™ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #62be36; --bg: #f0f2f5; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 420px; box-sizing: border-box; }
        h2 { text-align: center; margin: 0 0 15px; font-size: 20px; color: #333; }
        
        /* ç•«å¸ƒå€ */
        .preview-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #222; border-radius: 16px; overflow: hidden; border: 1px solid #ddd; margin-bottom: 15px; }
        #mainCanvas { width: 100%; height: 100%; display: block; }
        .loader-spin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* æ§åˆ¶å€ */
        .control-group { margin-bottom: 12px; }
        label { font-size: 13px; font-weight: bold; color: #555; display: block; margin-bottom: 6px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; box-sizing: border-box; font-size: 16px; }
        
        .custom-row { display: flex; gap: 10px; align-items: center; }
        input[type="color"] { width: 50px; height: 45px; border: none; padding: 0; background: none; cursor: pointer; }
        
        /* è²¼åœ–é¸å–® */
        .sticker-list { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; margin-bottom: 10px; }
        .sticker-item { font-size: 24px; padding: 8px; background: #f8f9fa; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; flex-shrink: 0; }
        .sticker-item.active { border-color: var(--primary); background: #eef9eb; }

        /* æŒ‰éˆ•å€ */
        .btn-stack { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { border: none; padding: 15px; border-radius: 14px; font-weight: bold; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .btn-random { background: #6c5ce7; color: white; }
        .btn-main { background: linear-gradient(135deg, #d4c84a, #62be36, #3672d9); color: white; grid-column: span 2; margin-top: 5px; box-shadow: 0 4px 15px rgba(98, 190, 54, 0.3); }
        .btn-share { background: #06C755; color: white; width: 100%; display: none; margin-top: 15px; font-size: 17px; }
        
        button:active { transform: scale(0.96); opacity: 0.9; }
        button:disabled { filter: grayscale(1); cursor: not-allowed; }

        #resultArea { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; display: none; }
        .link-text { font-size: 11px; color: #888; word-break: break-all; margin-top: 10px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        .loading-text { text-align: center; color: var(--primary); font-weight: bold; font-size: 14px; display: none; margin: 10px 0; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¨ AI æ—©å®‰åœ–å¤§å¸«</h2>
    
    <div class="preview-box">
        <div id="imgLoader" class="loader-spin"></div>
        <canvas id="mainCanvas" width="800" height="800"></canvas>
    </div>

    <div class="control-group">
        <label>1. è¼¸å…¥å•å€™èªèˆ‡é¸æ“‡é¡è‰²</label>
        <div class="custom-row">
            <input type="text" id="morningText" value="æ—©å®‰ï¼å¹³å®‰å–œæ¨‚" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—...">
            <input type="color" id="textColor" value="#ffffff">
        </div>
    </div>

    <label>2. é¸æ“‡è£é£¾è²¼åœ–</label>
    <div class="sticker-list" id="stickerList">
        <div class="sticker-item active" data-emoji="">âŒ</div>
        <div class="sticker-item" data-emoji="â˜€ï¸">â˜€ï¸</div>
        <div class="sticker-item" data-emoji="ğŸŒ¸">ğŸŒ¸</div>
        <div class="sticker-item" data-emoji="â˜•">â˜•</div>
        <div class="sticker-item" data-emoji="ğŸ¦‹">ğŸ¦‹</div>
        <div class="sticker-item" data-emoji="ğŸ€">ğŸ€</div>
        <div class="sticker-item" data-emoji="ğŸ±">ğŸ±</div>
        <div class="sticker-item" data-emoji="âœ¨">âœ¨</div>
    </div>

    <div class="btn-stack">
        <button class="btn-random" id="randomBtn" onclick="fetchRandomImage()">ğŸ”„ æ›å€‹ AI èƒŒæ™¯</button>
        <button class="btn-main" id="finalBtn" onclick="generateAndUpload()">âœ¨ ç”¢å‡ºä¸¦åˆ†äº«åˆ° LINE</button>
    </div>

    <div id="globalLoading" class="loading-text">ğŸš€ æ­£åœ¨ç”Ÿæˆç„¡é™åˆ¶é€£çµ...</div>

    <div id="resultArea">
        <button id="shareBtn" class="btn-share" onclick="directShare()">ğŸ“¤ å‚³é€çµ¦ LINE å¥½å‹</button>
        <div class="link-text" id="finalLink"></div>
    </div>
</div>

<script>
    const LIFF_ID = "2008941488-Phn5v50S"; 
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const imgLoader = document.getElementById('imgLoader');
    let currentBaseImage = new Image();
    let currentSticker = "";

    async function init() {
        try { await liff.init({ liffId: LIFF_ID }); } catch (e) {}
        fetchRandomImage();
        
        // ç›£è½æ‰€æœ‰è®Šå‹•
        document.getElementById('morningText').oninput = drawAll;
        document.getElementById('textColor').oninput = drawAll;
        
        // è²¼åœ–é¸æ“‡é‚è¼¯
        document.querySelectorAll('.sticker-item').forEach(item => {
            item.onclick = function() {
                document.querySelectorAll('.sticker-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentSticker = this.dataset.emoji;
                drawAll();
            };
        });
    }

    // å–å¾—éš¨æ©Ÿåœ– (ä½¿ç”¨ LoremFlickr + è·¨åŸŸä»£ç†)
    function fetchRandomImage() {
        const btn = document.getElementById('randomBtn');
        btn.disabled = true;
        imgLoader.style.display = 'block';

        const keywords = ['nature', 'morning', 'flowers', 'sunrise', 'garden'];
        const tag = keywords[Math.floor(Math.random() * keywords.length)];
        const rawUrl = `https://loremflickr.com/800/800/${tag}`;
        const proxyUrl = `https://images.weserv.nl/?url=${encodeURIComponent(rawUrl)}&w=800&h=800&fit=cover&t=${Date.now()}`;

        currentBaseImage = new Image();
        currentBaseImage.crossOrigin = "Anonymous";
        currentBaseImage.src = proxyUrl;
        currentBaseImage.onload = () => {
            drawAll();
            imgLoader.style.display = 'none';
            btn.disabled = false;
        };
    }

    function drawAll() {
        if (!currentBaseImage.complete) return;
        ctx.clearRect(0, 0, 800, 800);
        
        // 1. ç•«èƒŒæ™¯
        ctx.drawImage(currentBaseImage, 0, 0, 800, 800);
        
        // 2. ç•«è£é£¾è²¼åœ– (å›ºå®šåœ¨å³ä¸Šæ–¹)
        if (currentSticker) {
            ctx.font = "120px serif";
            ctx.textAlign = "right";
            ctx.fillText(currentSticker, 760, 150);
        }

        // 3. ç•«æ–‡å­—åº•å±¤é™°å½±æ¡†
        ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
        ctx.fillRect(0, 620, 800, 180);

        // 4. ç•«è‡ªè¨‚æ–‡å­—
        const text = document.getElementById('morningText').value || "æ—©å®‰";
        const color = document.getElementById('textColor').value;
        
        ctx.fillStyle = color;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = "bold 60px -apple-system, 'Microsoft JhengHei', sans-serif";
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 10;
        ctx.fillText(text, 400, 710);
    }

    async function generateAndUpload() {
        const btn = document.getElementById('finalBtn');
        const loader = document.getElementById('globalLoading');
        btn.disabled = true;
        loader.style.display = 'block';

        try {
            // 1. ç•«å¸ƒè½‰ Blob
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));
            
            // 2. ä½¿ç”¨ Telegraph ä¸Šå‚³ (ç„¡é™åˆ¶é¡åº¦)
            const formData = new FormData();
            formData.append("file", blob);
            
            const res = await fetch("https://telegra.ph/upload", {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            
            if (!data[0] || !data[0].src) throw new Error("Upload Error");

            const imgUrl = "https://telegra.ph" + data[0].src;
            
            // 3. ç”¢ç”Ÿ Deep Link
            const deepLink = `line://app/${LIFF_ID}/?i=${encodeURIComponent(imgUrl)}&w=800&h=800&f=AI_Master`;

            window.currentData = { imgUrl, deepLink };

            document.getElementById('finalLink').innerText = "é€£çµå·²ç”Ÿæˆï¼é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç™¼é€ã€‚";
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('shareBtn').style.display = 'block';
            
        } catch (e) {
            alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥");
            console.error(e);
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
        }
    }

    async function directShare() {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        try {
            await liff.shareTargetPicker([{
                "type": "flex",
                "altText": "é€ä½ ä¸€å¼µæ—©å®‰åœ–",
                "contents": {
                    "type": "bubble", "size": "mega",
                    "body": {
                        "type": "box", "layout": "vertical", "paddingAll": "0px",
                        "contents": [{
                            "type": "image", "url": window.currentData.imgUrl, "size": "full", 
                            "aspectMode": "fit", "aspectRatio": "1:1",
                            "action": { "type": "uri", "uri": window.currentData.deepLink }
                        }]
                    }
                }
            }]);
            liff.closeWindow();
        } catch (e) { alert("åˆ†äº«å¤±æ•—"); }
    }

    init();
</script>

</body>
</html>
