<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†ç”¨ AI æ—©å®‰åœ– - è‡ªç”±æ‹–æ›³ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --accent: #3672d9; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: #f3f5f7; margin: 0; padding: 15px; display: flex; justify-content: center; /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰é‡æ–°æ•´ç† */ overflow-y: auto; overscroll-behavior-y: contain; }
        .card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 450px; box-sizing: border-box; }
        
        /* ç•«å¸ƒå®¹å™¨ */
        .preview-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #eee; border-radius: 16px; overflow: hidden; border: 2px solid #e0e0e0; margin-bottom: 15px; touch-action: none; /* é—œéµï¼šé˜²æ­¢è§¸æ§æ™‚æ²å‹•é é¢ */ }
        #mainCanvas { width: 100%; height: 100%; display: block; cursor: grab; }
        #mainCanvas:active { cursor: grabbing; }
        
        .control-label { font-size: 14px; font-weight: bold; color: #444; margin: 12px 0 8px; display: block; }
        .input-row { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; }
        input[type="color"] { width: 50px; height: 48px; border: none; background: none; cursor: pointer; padding: 0; }
        
        .sticker-bar { display: flex; gap: 10px; overflow-x: auto; padding: 5px 2px; margin-bottom: 20px; scrollbar-width: none; }
        .sticker-bar::-webkit-scrollbar { display: none; }
        .sticker { font-size: 26px; padding: 10px; background: #f7f7f7; border-radius: 14px; cursor: pointer; transition: 0.2s; border: 2px solid transparent; min-width: 30px; text-align: center; }
        .sticker.active { border-color: var(--accent); background: #eef4ff; transform: scale(1.05); }

        .btn-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px; margin-top: 20px; }
        button { border: none; padding: 14px; border-radius: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 15px; }
        .btn-refresh { background: #e1e5ea; color: #333; }
        .btn-confirm { background: linear-gradient(135deg, #62be36, #3672d9); color: white; box-shadow: 0 4px 12px rgba(98, 190, 54, 0.3); }
        .btn-share { background: var(--line-green); color: white; width: 100%; display: none; margin-top: 15px; font-size: 18px; padding: 16px; }
        button:active { transform: scale(0.97); opacity: 0.9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .status-box { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 15px; display: none; text-align: center; }
        .link-result { margin-top: 15px; padding: 12px; background: #f8f9fa; border: 1px solid #eee; border-radius: 10px; font-size: 12px; color: #555; word-break: break-all; display: none; font-family: monospace; }
        
        #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; z-index: 10; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <h3 style="text-align: center; margin-top: 5px; color: #333;">âœ¨ AI æ—©å®‰åœ– (è‡ªç”±æ‹–æ›³ç‰ˆ)</h3>
    <p style="text-align: center; font-size: 13px; color: #666; margin-bottom: 15px;">ğŸ’¡ æç¤ºï¼šæ–‡å­—èˆ‡è²¼åœ–éƒ½å¯ä»¥ç”¨æ‰‹æŒ‡æ‹–æ›³ç§»å‹•å–”ï¼</p>
    
    <div class="preview-box">
        <div id="loader"></div>
        <canvas id="mainCanvas" width="800" height="800"></canvas>
    </div>

    <span class="control-label">âœï¸ ç·¨è¼¯æ–‡å­—èˆ‡é¡è‰²</span>
    <div class="input-row">
        <input type="text" id="txt" value="æ—©å®‰ï¼Œé †å¿ƒå¦‚æ„" maxlength="20">
        <input type="color" id="clr" value="#ffffff">
    </div>

    <span class="control-label">ğŸ¨ é¸æ“‡è£é£¾è²¼åœ–</span>
    <div class="sticker-bar">
        <div class="sticker active" data-v="">ç„¡</div>
        <div class="sticker" data-v="â˜€ï¸">â˜€ï¸</div>
        <div class="sticker" data-v="ğŸŒ¸">ğŸŒ¸</div>
        <div class="sticker" data-v="ğŸ€">ğŸ€</div>
        <div class="sticker" data-v="â˜•">â˜•</div>
        <div class="sticker" data-v="ğŸ’–">ğŸ’–</div>
        <div class="sticker" data-v="ğŸ¦‹">ğŸ¦‹</div>
        <div class="sticker" data-v="ğŸŒˆ">ğŸŒˆ</div>
    </div>

    <div class="btn-grid">
        <button class="btn-refresh" onclick="loadUnsplashImg()">ğŸ”„ æ›èƒŒæ™¯</button>
        <button class="btn-confirm" id="genBtn" onclick="handleUpload()">âœ… å®Œæˆï¼Œç”¢ç”Ÿé€£çµ</button>
    </div>

    <div id="status" class="status-box"></div>
    <div id="linkResult" class="link-result"></div>
    <button id="shareBtn" class="btn-share" onclick="shareToLine()">ğŸ“¤ ä¸€éµåˆ†äº«åˆ° LINE</button>
</div>

<script>
    // ==============================
    // é‡è¦ï¼šè«‹å¡«å…¥æ‚¨çš„ Unsplash Access Key
    // ==============================
    const UNSPLASH_KEY = "UgZ1pLt9-I5t6BMM71gGBCWZHQk_3oXxYA4uhrHgsVw"; 
    const LIFF_ID = "2008941488-Phn5v50S";
    
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let bgImg = new Image();
    
    // --- ç‹€æ…‹ç®¡ç† (ä½ç½®èˆ‡æ‹–æ›³) ---
    let currentEmoji = "";
    let textPos = { x: 400, y: 650 };    // æ–‡å­—é è¨­ä½ç½®
    let stickerPos = { x: 700, y: 120 }; // è²¼åœ–é è¨­ä½ç½®
    
    let isDragging = null; // 'text' æˆ– 'sticker'
    let dragStart = { x: 0, y: 0 };
    let itemStart = { x: 0, y: 0 };

    async function init() {
        try { await liff.init({ liffId: LIFF_ID }); } catch(e) {}
        loadUnsplashImg(); // åˆå§‹è¼‰å…¥åœ–ç‰‡
        
        // äº‹ä»¶ç›£è½ï¼šè¼¸å…¥æ¡†
        document.getElementById('txt').oninput = draw;
        document.getElementById('clr').oninput = draw;
        
        // äº‹ä»¶ç›£è½ï¼šè²¼åœ–é¸æ“‡
        document.querySelectorAll('.sticker').forEach(s => {
            s.onclick = function() {
                document.querySelectorAll('.sticker').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentEmoji = this.dataset.v;
                draw();
            }
        });

        // äº‹ä»¶ç›£è½ï¼šCanvas æ‹–æ›³ (æ»‘é¼  + è§¸æ§)
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchmove', handleMove, { passive: false });
        window.addEventListener('mouseup', handleEnd);
        window.addEventListener('touchend', handleEnd);
    }

    // --- Canvas æ‹–æ›³é‚è¼¯ ---
    function getCanvasCoordinates(event) {
        const rect = canvas.getBoundingClientRect();
        // è€ƒæ…® Canvas å¯¦éš›é¡¯ç¤ºå¤§å°èˆ‡è§£æåº¦çš„æ¯”ä¾‹
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        let clientX, clientY;
        if (event.touches && event.touches.length > 0) {
            clientX = event.touches[0].clientX;
            clientY = event.touches[0].clientY;
        } else {
            clientX = event.clientX;
            clientY = event.clientY;
        }
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function handleStart(e) {
        if (e.type === 'touchstart') e.preventDefault(); // é˜²æ­¢æ²å‹•
        const mousePos = getCanvasCoordinates(e);

        // ç°¡å–®ç¢°æ’æª¢æ¸¬ (åˆ¤å®šé»æ“Šç¯„åœ)
        // æª¢æ¸¬è²¼åœ– (å‡è¨­ç´„ 150x150 å¤§å°)
        if (currentEmoji && Math.abs(mousePos.x - stickerPos.x) < 80 && Math.abs(mousePos.y - stickerPos.y) < 80) {
            isDragging = 'sticker';
            itemStart = { ...stickerPos };
        } 
        // æª¢æ¸¬æ–‡å­— (å‡è¨­ç´„ 600x100 å¤§å°ï¼Œä¸­å¿ƒé»åˆ¤å®š)
        else if (Math.abs(mousePos.x - textPos.x) < 300 && Math.abs(mousePos.y - textPos.y) < 60) {
            isDragging = 'text';
            itemStart = { ...textPos };
        }

        if (isDragging) {
            dragStart = mousePos;
        }
    }

    function handleMove(e) {
        if (!isDragging) return;
        if (e.type === 'touchmove') e.preventDefault();
        
        const mousePos = getCanvasCoordinates(e);
        const dx = mousePos.x - dragStart.x;
        const dy = mousePos.y - dragStart.y;

        if (isDragging === 'sticker') {
            stickerPos.x = itemStart.x + dx;
            stickerPos.y = itemStart.y + dy;
        } else if (isDragging === 'text') {
            textPos.x = itemStart.x + dx;
            textPos.y = itemStart.y + dy;
        }
        draw();
    }

    function handleEnd() {
        isDragging = null;
    }

    // --- ç¹ªåœ–èˆ‡ API é‚è¼¯ ---
    async function loadUnsplashImg() {
        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        // å¦‚æœæ²’æœ‰ Keyï¼Œä½¿ç”¨å‚™ç”¨åœ–æºä»¥ä¾¿æ¸¬è©¦
        if (UNSPLASH_KEY === "UgZ1pLt9-I5t6BMM71gGBCWZHQk_3oXxYA4uhrHgsVw") {
             // alert("è«‹è¨˜å¾—å¡«å…¥ Unsplash API Key æ‰èƒ½ç²å¾—å•†ç”¨åœ–ï¼ç›®å‰ä½¿ç”¨æ¸¬è©¦åœ–æºã€‚");
             var url = `https://loremflickr.com/800/800/morning,sunshine?t=${Date.now()}`;
        } else {
             var themes = ['morning', 'nature', 'sunlight', 'calm', 'flowers'];
             var query = themes[Math.floor(Math.random()*themes.length)];
             var url = `https://api.unsplash.com/photos/random?query=${query}&orientation=squarish&client_id=${UNSPLASH_KEY}`;
        }
        
        try {
            let imgUrl = url;
            // å¦‚æœæ˜¯ Unsplash APIï¼Œéœ€è¦è§£æ JSON
            if (UNSPLASH_KEY !== "UgZ1pLt9-I5t6BMM71gGBCWZHQk_3oXxYA4uhrHgsVw") {
                const res = await fetch(url);
                const data = await res.json();
                imgUrl = data.urls.regular;
            }

            bgImg = new Image();
            bgImg.crossOrigin = "Anonymous";
            // ä½¿ç”¨ä»£ç†ç¢ºä¿è·¨åŸŸæ­£å¸¸
            bgImg.src = `https://images.weserv.nl/?url=${encodeURIComponent(imgUrl)}&w=800&h=800&fit=cover`;
            bgImg.onload = () => {
                draw();
                loader.style.display = 'none';
            };
            bgImg.onerror = () => { throw new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—"); }
        } catch (e) {
            alert("ç„¡æ³•è¼‰å…¥åœ–ç‰‡ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Keyã€‚");
            loader.style.display = 'none';
            // è¼‰å…¥å¤±æ•—æ™‚ç¹ªè£½ä¸€å€‹ç´”è‰²èƒŒæ™¯é¿å…ç©ºç™½
            ctx.fillStyle = "#ddd"; ctx.fillRect(0,0,800,800); draw();
        }
    }

    function draw() {
        ctx.clearRect(0,0,800,800);
        // 1. èƒŒæ™¯
        if (bgImg.complete && bgImg.naturalWidth > 0) {
            ctx.drawImage(bgImg, 0, 0, 800, 800);
        } else {
            ctx.fillStyle = "#eee"; ctx.fillRect(0,0,800,800);
        }

        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        // 2. è²¼åœ– (å¯æ‹–æ›³)
        if (currentEmoji) {
            ctx.font = "120px serif";
            ctx.shadowColor = "rgba(0,0,0,0.3)";
            ctx.shadowBlur = 5;
            ctx.fillText(currentEmoji, stickerPos.x, stickerPos.y);
            ctx.shadowBlur = 0; // é‡ç½®é™°å½±
        }

        // 3. æ–‡å­— (å¯æ‹–æ›³)
        const text = document.getElementById('txt').value || "æ—©å®‰";
        ctx.font = "bold 60px -apple-system, 'Microsoft JhengHei', sans-serif";
        
        // ç¹ªè£½æ–‡å­—èƒŒæ™¯æ¡† (è·Ÿéš¨æ–‡å­—ä½ç½®)
        const textWidth = ctx.measureText(text).width;
        ctx.fillStyle = "rgba(0,0,0,0.4)";
        // ç°¡å–®è¨ˆç®—èƒŒæ™¯æ¡†ä½ç½®
        ctx.fillRect(textPos.x - textWidth/2 - 20, textPos.y - 50, textWidth + 40, 100);

        // ç¹ªè£½æ–‡å­—æœ¬é«”
        ctx.fillStyle = document.getElementById('clr').value;
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 8;
        ctx.fillText(text, textPos.x, textPos.y);
    }

    async function handleUpload() {
        const status = document.getElementById('status');
        const linkResult = document.getElementById('linkResult');
        const shareBtn = document.getElementById('shareBtn');
        const genBtn = document.getElementById('genBtn');
        
        status.style.display = 'block';
        status.innerText = "â³ æ­£åœ¨è™•ç†åœ–ç‰‡ä¸¦ä¸Šå‚³ï¼Œè«‹ç¨å€™...";
        status.style.background = "#fff3cd"; color: "#856404";
        genBtn.disabled = true;
        linkResult.style.display = 'none';
        shareBtn.style.display = 'none';

        try {
            // è½‰ç‚º Blob
            const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));
            const formData = new FormData();
            formData.append("file", blob);

            // ä¸Šå‚³è‡³ Telegraph
            const res = await fetch("https://telegra.ph/upload", { method: "POST", body: formData });
            const data = await res.json();
            
            if (!data || !data[0] || !data[0].src) throw new Error("Telegraph Upload Failed");
            const finalImg = "https://telegra.ph" + data[0].src;
            
            // ç”¢ç”Ÿ Deep Link
            const deepLink = `line://app/${LIFF_ID}/?i=${encodeURIComponent(finalImg)}&w=800&h=800&f=AI_Draggable`;

            window.shareData = { img: finalImg, link: deepLink };

            status.innerText = "âœ… æˆåŠŸï¼æ‚¨å¯ä»¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•åˆ†äº«ï¼Œæˆ–è¤‡è£½é€£çµã€‚";
            status.style.background = "#d4edda"; status.style.color = "#155724";
            
            // é¡¯ç¤ºç”¢å‡ºçš„é€£çµ (ä¿®å¾©é»)
            linkResult.innerText = deepLink;
            linkResult.style.display = 'block';
            shareBtn.style.display = 'block';
        } catch (e) {
            console.error(e);
            status.innerText = "âŒ ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚";
            status.style.background = "#f8d7da"; status.style.color = "#721c24";
        } finally {
            genBtn.disabled = false;
        }
    }

    async function shareToLine() {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        if (!window.shareData) { alert("è«‹å…ˆå®Œæˆç”Ÿæˆæ­¥é©Ÿ"); return; }
        
        try {
            const res = await liff.shareTargetPicker([{
                "type": "flex",
                "altText": "æ‚¨æ”¶åˆ°ä¸€å¼µæ—©å®‰åœ–å¡",
                "contents": {
                    "type": "bubble", "size": "mega",
                    "body": {
                        "type": "box", "layout": "vertical", "paddingAll": "0px",
                        "contents": [{
                            "type": "image", "url": window.shareData.img, "size": "full", "aspectRatio": "1:1",
                            "action": { "type": "uri", "uri": window.shareData.link }
                        }]
                    }
                }
            }]);
            if (res) liff.closeWindow();
        } catch (e) { 
            alert("åˆ†äº«åŠŸèƒ½ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¢ºèª LIFF è¨­å®šæˆ–ç›´æ¥è¤‡è£½é€£çµã€‚"); 
        }
    }

    init();
</script>
</body>
</html>
