<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº« EDM é€£çµç”¢ç”Ÿå™¨ v4</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 380px; }
        h2 { color: #02c874; text-align: center; font-size: 20px; margin-bottom: 5px; }
        p { font-size: 12px; color: #777; text-align: center; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background: #02c874; color: white; border: none; padding: 14px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 16px; }
        .result-area { margin-top: 20px; display: none; }
        .link-label { font-size: 12px; font-weight: bold; color: #555; margin-top: 15px; display: block; }
        .link-box { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; word-break: break-all; font-size: 13px; font-family: monospace; position: relative; margin-top: 5px; line-height: 1.5; }
        .copy-btn { background: #444; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; float: right; margin-bottom: 5px; }
        .preview-text { color: #02c874; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸš€ EDM åˆ†äº«é€£çµç”¢ç”Ÿå™¨</h2>
    <p>è²¼ä¸Šåœ–ç‰‡ç¶²å€ç”¢å‡ºå¯åˆ†äº«EDMé€£çµ</p>
    
    <input type="url" id="imgUrl" placeholder="è«‹è²¼ä¸Šåœ–ç‰‡ç¶²å€">
    <button id="genBtn" onclick="generate()">ç”¢ç”Ÿé€£çµ</button>

    <div id="resultArea" class="result-area">
        <span class="link-label">1. LINE å°ˆç”¨ (é»æ“Šæœ€é †æš¢):</span>
        <div class="link-box">
            <button class="copy-btn" onclick="copyText('deepLink')">è¤‡è£½å…§å®¹</button>
            <div id="deepLink_display">
                <span class="preview-text">ğŸ””æ‰“é–‹EDMé€£çµï¼š</span><br>
                <span id="deepLink">---</span>
            </div>
        </div>

        <span class="link-label">2. è¬ç”¨ç¶²é çŸ­ç¶²å€ (é©åˆå¤–éƒ¨è½‰è²¼):</span>
        <div class="link-box">
            <button class="copy-btn" onclick="copyText('shortLink')">è¤‡è£½å…§å®¹</button>
            <div id="shortLink_display">
                <span class="preview-text">ğŸ””æ‰“é–‹EDMé€£çµï¼š</span><br>
                <span id="shortLink">---</span>
            </div>
        </div>
    </div>
</div>

<script>
    const LIFF_ID = "2008941488-Phn5v50S";
    const PROXY = 'https://corsproxy.io/?';

    async function generate() {
        const rawImgUrl = document.getElementById('imgUrl').value.trim();
        if(!rawImgUrl) return alert("è«‹è¼¸å…¥åœ–ç‰‡ç¶²å€");

        const btn = document.getElementById('genBtn');
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨æ¥µé€Ÿç¸®çŸ­ä¸­...";

        try {
            // 1. å…ˆç¸®çŸ­åœ–ç‰‡ç¶²å€
            const shortImgUrl = await getShortUrl(rawImgUrl);
            
            // 2. ç²å–åœ–ç‰‡å°ºå¯¸
            const dims = await getImageDimensions(rawImgUrl);

            // 3. çµ„åˆé€£çµ
            const liffBase = `https://liff.line.me/${LIFF_ID}/?i=${encodeURIComponent(shortImgUrl)}&w=${dims.w}&h=${dims.h}`;
            const deepLink = `line://app/${LIFF_ID}/?i=${encodeURIComponent(shortImgUrl)}&w=${dims.w}&h=${dims.h}`;

            // 4. å†ç¸®çŸ­ä¸€æ¬¡ LIFF ç¶²å€
            const finalShort = await getShortUrl(liffBase);

            document.getElementById('deepLink').innerText = deepLink;
            document.getElementById('shortLink').innerText = finalShort;
            document.getElementById('resultArea').style.display = 'block';

        } catch (e) {
            alert("ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        } finally {
            btn.disabled = false;
            btn.innerText = "ç”¢ç”Ÿä¸¦å„ªåŒ–é€£çµ";
        }
    }

    async function getShortUrl(longUrl) {
        try {
            const api = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`;
            const response = await fetch(PROXY + encodeURIComponent(api));
            const data = await response.json();
            return data.shorturl || longUrl;
        } catch (e) { return longUrl; }
    }

    function getImageDimensions(url) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve({w: img.width, h: img.height});
            img.onerror = () => resolve({w: 800, h: 800});
            img.src = url;
        });
    }

    function copyText(id) {
        const url = document.getElementById(id).innerText;
        const fullText = `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${url}`; // åŠ ä¸Šå‰ç¶´èˆ‡æ›è¡Œ
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(fullText).then(() => alert("å…§å®¹å·²è¤‡è£½ï¼Œå¯ç›´æ¥è²¼å¾€ LINE åˆ†äº«"));
        } else {
            // å‚™ä»½è¤‡è£½æ–¹æ¡ˆ
            const el = document.createElement('textarea');
            el.value = fullText;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("å…§å®¹å·²è¤‡è£½");
        }
    }
</script>
</body>
</html>
