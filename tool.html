<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—©å®‰åœ–ç·¨è¼¯ç”¢ç”Ÿå™¨</title>
    <style>
        :root { --primary: linear-gradient(90deg, #d4c84a 0%, #62be36 50%, #3672d9 100%); }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        h2 { color: #3672d9; margin: 0; }
        
        /* ç·¨è¼¯å€åŸŸ */
        #canvasContainer { position: relative; margin: 15px 0; background: #eee; border-radius: 8px; overflow: hidden; touch-action: none; cursor: crosshair; line-height: 0; }
        canvas { max-width: 100%; height: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        .sticker-box { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; border-top: 1px solid #eee; }
        .sticker-item { font-size: 30px; cursor: pointer; background: #f8f9fa; padding: 5px; border-radius: 5px; min-width: 40px; }

        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin: 5px 0; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        .btn-secondary { background: #666; }
        
        .result-area { display: none; background: #e8f0fe; padding: 15px; border-radius: 10px; margin-top: 15px; word-break: break-all; }
        .link-box { font-size: 12px; background: white; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #cce; }
    </style>
</head>
<body>

<div class="card">
    <h2>â˜€ï¸ æ—©å®‰åœ–é€£çµç”¢ç”Ÿå™¨</h2>
    <p style="font-size: 12px; color: #666;">éš¨æ©Ÿ AI åœ–åº« Ã— è‡ªç”±ç·¨è¼¯ Ã— è½‰å‚³è¿½è¹¤</p>

    <div id="canvasContainer">
        <canvas id="editorCanvas" width="800" height="800"></canvas>
    </div>

    <div class="controls">
        <button class="btn-secondary" onclick="fetchRandomImage()">ğŸ”„ æ›ä¸€å¼µéš¨æ©Ÿåœ–</button>
        <button class="btn-secondary" onclick="resetElements()">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è£é£¾</button>
        <input type="text" id="textInput" placeholder="è¼¸å…¥æ—©å®‰å•å€™èª..." oninput="updateText()">
        <input type="color" id="colorPicker" value="#ffffff" onchange="draw()">
    </div>

    <div class="sticker-box">
        <div class="sticker-item" onclick="addSticker('â˜€ï¸')">â˜€ï¸</div>
        <div class="sticker-item" onclick="addSticker('ğŸŒ¸')">ğŸŒ¸</div>
        <div class="sticker-item" onclick="addSticker('â˜•')">â˜•</div>
        <div class="sticker-item" onclick="addSticker('ğŸ€')">ğŸ€</div>
        <div class="sticker-item" onclick="addSticker('ğŸŒ¹')">ğŸŒ¹</div>
        <div class="sticker-item" onclick="addSticker('ğŸ™')">ğŸ™</div>
        <div class="sticker-item" onclick="addSticker('âœ¨')">âœ¨</div>
    </div>

    <button id="genBtn" onclick="uploadAndGenerate()">ğŸš€ ç”¢ç”Ÿä¸¦è½‰ç‚º LIFF é€£çµ</button>

    <div id="resultArea" class="result-area">
        <strong>âœ… é€£çµå·²ç”¢ç”Ÿï¼</strong>
        <div class="link-box" id="finalLiffUrl">é€£çµè¼‰å…¥ä¸­...</div>
        <button style="margin-top:10px" onclick="copyLink()">è¤‡è£½é€£çµè½‰å‚³</button>
    </div>
</div>

<script>
    const LIFF_ID = "2008941488-Phn5v50S";
    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');
    let bgImg = new Image();
    let elements = [
        { type: 'text', x: 400, y: 700, text: 'æ—©å®‰ï¼Œç¥æ‚¨æœ‰å€‹ç¾å¥½çš„ä¸€å¤©', size: 40, color: '#ffffff' }
    ];
    let isDragging = false;
    let selectedElement = null;

    // 1. åˆå§‹åŒ–åœ–åº« (ä½¿ç”¨ Unsplash å…è²»åœ–åº«)
    function fetchRandomImage() {
        const keywords = ['nature', 'morning', 'flowers', 'sunrise'];
        const randomKey = keywords[Math.floor(Math.random() * keywords.length)];
        bgImg.crossOrigin = "anonymous";
        bgImg.src = `https://images.unsplash.com/photo-1470252649358-96947c03389b?auto=format&fit=crop&w=800&q=80&sig=${Math.random()}`;
        bgImg.onload = draw;
    }

    // 2. ç•«å¸ƒç¹ªè£½é‚è¼¯
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (bgImg.src) {
            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
        }
        
        elements.forEach(el => {
            if (el.type === 'text') {
                ctx.fillStyle = document.getElementById('colorPicker').value;
                ctx.font = `bold ${el.size}px "Microsoft JhengHei", sans-serif`;
                ctx.textAlign = "center";
                ctx.strokeStyle = "black";
                ctx.lineWidth = 4;
                ctx.strokeText(el.text, el.x, el.y);
                ctx.fillText(el.text, el.x, el.y);
            } else if (el.type === 'sticker') {
                ctx.font = `${el.size}px serif`;
                ctx.fillText(el.text, el.x, el.y);
            }
        });
    }

    function updateText() {
        elements[0].text = document.getElementById('textInput').value || 'æ—©å®‰ï¼Œç¥æ‚¨æœ‰å€‹ç¾å¥½çš„ä¸€å¤©';
        draw();
    }

    function addSticker(emoji) {
        elements.push({ type: 'sticker', x: 400, y: 400, text: emoji, size: 80 });
        draw();
    }

    function resetElements() {
        elements = [elements[0]]; // åªä¿ç•™ä¸»æ–‡å­—
        draw();
    }

    // 3. æ‹–æ‹‰åŠŸèƒ½
    canvas.onmousedown = canvas.ontouchstart = (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        const mouseX = (clientX - rect.left) * scaleX;
        const mouseY = (clientY - rect.top) * scaleY;

        selectedElement = elements.findLast(el => 
            Math.abs(el.x - mouseX) < 100 && Math.abs(el.y - mouseY) < 100
        );
        if (selectedElement) isDragging = true;
    };

    window.onmousemove = window.ontouchmove = (e) => {
        if (!isDragging || !selectedElement) return;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
        selectedElement.x = (clientX - rect.left) * (canvas.width / rect.width);
        selectedElement.y = (clientY - rect.top) * (canvas.height / rect.height);
        draw();
    };

    window.onmouseup = window.ontouchend = () => isDragging = false;

    // 4. ä¸Šå‚³åœ–ç‰‡ä¸¦å°æ¥ LIFF
    async function uploadAndGenerate() {
        const btn = document.getElementById('genBtn');
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨åˆæˆä¸¦ä¸Šå‚³...";

        try {
            // å°‡ç•«å¸ƒè½‰ç‚º Blob
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
            
            // ä½¿ç”¨ Imgur æˆ–é¡ä¼¼ API ä¸Šå‚³ (æ­¤è™•ä»¥åŒ¿åä¸Šå‚³ç¯„ä¾‹ï¼Œå¯¦å‹™ä¸Šå»ºè­°ç”¨æ‚¨è‡ªå·±çš„ä¼ºæœå™¨)
            const formData = new FormData();
            formData.append('image', blob);

            const uploadRes = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: { Authorization: 'Client-ID 7f33887d163353e' }, // å»ºè­°æ›´æ›ç‚ºæ‚¨çš„ Client-ID
                body: formData
            });
            const data = await uploadRes.json();
            const finalImgUrl = data.data.link;

            // ç”¢ç”Ÿ LIFF é€£çµ
            const liffBase = `https://liff.line.me/${LIFF_ID}/?i=${encodeURIComponent(finalImgUrl)}&w=800&h=800&f=AI_Gen`;
            
            // ç¸®ç¶²å€ (å¯é¸)
            document.getElementById('finalLiffUrl').innerText = liffBase;
            document.getElementById('resultArea').style.display = 'block';
            btn.innerText = "ç”¢ç”ŸæˆåŠŸï¼";
        } catch (e) {
            alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼š" + e.message);
            btn.disabled = false;
            btn.innerText = "ğŸš€ ç”¢ç”Ÿä¸¦è½‰ç‚º LIFF é€£çµ";
        }
    }

    function copyLink() {
        const link = document.getElementById('finalLiffUrl').innerText;
        navigator.clipboard.writeText(`â˜€ï¸é€æ‚¨ä¸€å¼µæ—©å®‰ç¥ç¦ï¼š\n${link}`).then(() => alert("å·²è¤‡è£½é€£çµï¼Œè¶•å¿«å» LINE ç¾¤çµ„åˆ†äº«å§ï¼"));
    }

    fetchRandomImage();
</script>
</body>
</html>
