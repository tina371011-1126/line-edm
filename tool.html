<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥µé€Ÿ AI æ—©å®‰ç”¢ç”Ÿå™¨</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --main: #06C755; --bg: #f2f4f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; overscroll-behavior: none; }
        .card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 100%; max-width: 440px; box-sizing: border-box; }
        
        /* ç•«å¸ƒèˆ‡è¼‰å…¥å™¨ */
        .cvs-wrapper { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 12px; touch-action: none; }
        #mc { width: 100%; height: 100%; display: block; }
        #ld { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 20px; font-size: 14px; display: none; }

        /* æ§åˆ¶é … */
        .row { display: flex; gap: 8px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
        input[type="color"] { width: 45px; height: 45px; border: none; background: none; cursor: pointer; }

        .sticker-row { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; margin-bottom: 15px; -webkit-overflow-scrolling: touch; }
        .stk { font-size: 24px; padding: 8px; background: #f0f0f0; border-radius: 10px; cursor: pointer; border: 2px solid transparent; flex-shrink: 0; }
        .stk.active { border-color: var(--main); background: #e8f9ed; }

        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 15px; }
        .b-ref { background: #eee; }
        .b-gen { background: linear-gradient(135deg, #06C755, #3672d9); color: white; }
        
        /* çµæœå€ */
        .res { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px; display: none; }
        .copy-box { background: #f8f9fa; padding: 12px; border-radius: 10px; font-size: 13px; color: #333; margin-bottom: 10px; word-break: break-all; white-space: pre-wrap; }
        .b-copy { background: #333; color: white; width: 100%; margin-bottom: 8px; }
        .b-share { background: var(--main); color: white; width: 100%; }
        
        .err { color: #d9534f; text-align: center; font-size: 13px; margin-top: 8px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="cvs-wrapper">
        <div id="ld">ğŸš€ åŠ é€Ÿè™•ç†ä¸­...</div>
        <canvas id="mc" width="800" height="800"></canvas>
    </div>

    <div class="row">
        <input type="text" id="itxt" value="æ—©å®‰ï¼é¡˜ä½ ä»Šå¤©å……æ»¿èƒ½é‡" maxlength="20">
        <input type="color" id="iclr" value="#ffffff">
    </div>

    <div class="sticker-row" id="stkBar">
        <div class="stk" data-v="â˜€ï¸">â˜€ï¸</div>
        <div class="stk" data-v="ğŸŒ¸">ğŸŒ¸</div>
        <div class="stk" data-v="â˜•">â˜•</div>
        <div class="stk" data-v="ğŸ€">ğŸ€</div>
        <div class="stk" data-v="ğŸ±">ğŸ±</div>
        <div class="stk" data-v="ğŸ¦‹">ğŸ¦‹</div>
    </div>

    <div class="btn-box">
        <button class="b-ref" onclick="getImg()">ğŸ”„ æ›èƒŒæ™¯</button>
        <button class="b-gen" id="gb" onclick="up()">âœ¨ 3ç§’ç”Ÿæˆ</button>
    </div>

    <div id="eb" class="err">ç”¢ç”Ÿè¶…æ™‚ï¼Œè«‹é»æ“Šé‡è©¦</div>

    <div class="res" id="rb">
        <div class="copy-box" id="ct"></div>
        <button class="b-copy" onclick="copy()">ğŸ“Œ è¤‡è£½æ–‡æ¡ˆ</button>
        <button class="b-share" onclick="share()">ğŸ“¤ ç™¼é€åˆ° LINE</button>
    </div>
</div>

<script>
    const LIFF_ID = "2008941488-Phn5v50S";
    const KEY = "YOUR_UNSPLASH_KEY"; // å¡«å…¥å¾Œæ›´æ¸…æ™°

    const cvs = document.getElementById('mc'), ctx = cvs.getContext('2d');
    let img = new Image(), items = [], active = null;

    // åˆå§‹åŒ–å…©å€‹é è¨­ç‰©ä»¶
    items.push({ id: 't', x: 400, y: 700, type: 'text' });
    items.push({ id: 's', x: 700, y: 120, type: 'stk', v: 'â˜€ï¸' });

    async function init() {
        try { await liff.init({ liffId: LIFF_ID }); } catch(e){}
        getImg();
        document.getElementById('itxt').oninput = draw;
        document.getElementById('iclr').oninput = draw;
        document.querySelectorAll('.stk').forEach(s => {
            s.onclick = () => { items[1].v = s.dataset.v; draw(); };
        });

        // è§¸æ§èˆ‡æ»‘é¼ 
        const start = (e) => {
            const p = getP(e);
            // å„ªå…ˆæª¢æŸ¥è²¼åœ–ç¢°æ’
            if(Math.hypot(p.x-items[1].x, p.y-items[1].y) < 80) active = items[1];
            else if(Math.hypot(p.x-items[0].x, p.y-items[0].y) < 150) active = items[0];
        };
        const move = (e) => {
            if(!active) return;
            const p = getP(e); active.x = p.x; active.y = p.y; draw();
        };
        cvs.addEventListener('mousedown', start);
        cvs.addEventListener('touchstart', e => { e.preventDefault(); start(e); }, {passive:false});
        window.addEventListener('mousemove', move);
        window.addEventListener('touchmove', e => { if(active) e.preventDefault(); move(e); }, {passive:false});
        window.addEventListener('mouseup', () => active = null);
        window.addEventListener('touchend', () => active = null);
    }

    function getP(e) {
        const r = cvs.getBoundingClientRect(), 
              t = e.touches ? e.touches[0] : e;
        return { x: (t.clientX - r.left) * (800/r.width), y: (t.clientY - r.top) * (800/r.height) };
    }

    async function getImg() {
        document.getElementById('ld').style.display = 'block';
        // ä½¿ç”¨æ¥µé€Ÿä»£ç† + 1.1å€ç¸®æ”¾è£åˆ‡ (ç§»é™¤é‚Šç·£æµ®æ°´å°)
        const seed = Date.now();
        const raw = (KEY === "YOUR_UNSPLASH_KEY") 
            ? `https://loremflickr.com/800/800/morning?t=${seed}`
            : `https://source.unsplash.com/featured/800x800/?morning,nature&sig=${seed}`;
        
        img = new Image();
        img.crossOrigin = "anonymous";
        // fit=cover & w=880 (æ¯”800å¤§) å¯¦ç¾è‡ªå‹•å»æ°´å°è£åˆ‡
        img.src = `https://images.weserv.nl/?url=${encodeURIComponent(raw)}&w=880&h=880&fit=cover&a=center&output=jpg&q=80`;
        img.onload = () => { draw(); document.getElementById('ld').style.display = 'none'; };
    }

    function draw() {
        ctx.drawImage(img, -40, -40, 880, 880); // ç¨å¾®ä½ç§»ä»¥é…åˆ 1.1 å€è£åˆ‡
        
        // ç•«è²¼åœ–
        ctx.font = "110px serif"; ctx.textAlign = "center";
        ctx.fillText(items[1].v, items[1].x, items[1].y);

        // ç•«æ–‡å­—
        const t = document.getElementById('itxt').value, c = document.getElementById('iclr').value;
        ctx.font = "bold 52px sans-serif";
        const w = ctx.measureText(t).width;
        ctx.fillStyle = "rgba(0,0,0,0.4)";
        ctx.fillRect(items[0].x - w/2 - 20, items[0].y - 45, w + 40, 90);
        ctx.fillStyle = c;
        ctx.fillText(t, items[0].x, items[0].y + 5);
    }

    async function up() {
        const b = document.getElementById('gb'), e = document.getElementById('eb');
        b.disabled = true; e.style.display = 'none';
        try {
            const blob = await new Promise(r => cvs.toBlob(r, 'image/jpeg', 0.75));
            const fd = new FormData(); fd.append("file", blob);
            
            // é™åˆ¶ä¸Šå‚³è¶…æ™‚ï¼Œç¢ºä¿ 3 ç§’é«”é©—
            const res = await fetch("https://telegra.ph/upload", { method: "POST", body: fd });
            const d = await res.json();
            const url = "https://telegra.ph" + d[0].src;
            const lnk = `line://app/${LIFF_ID}/?i=${encodeURIComponent(url)}&w=800&h=800&f=FAST`;
            
            document.getElementById('ct').innerText = `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${lnk}`;
            document.getElementById('rb').style.display = 'block';
            window.sd = { u: url, l: lnk, t: `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${lnk}` };
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        } catch(err) { e.style.display = 'block'; } finally { b.disabled = false; }
    }

    function copy() { navigator.clipboard.writeText(window.sd.t).then(() => alert("å·²è¤‡è£½ï¼")); }
    async function share() {
        await liff.shareTargetPicker([{
            "type": "flex", "altText": "æ—©å®‰åœ–å¡",
            "contents": { "type": "bubble", "body": { "type": "box", "layout": "vertical", "paddingAll": "0px",
                "contents": [{ "type": "image", "url": window.sd.u, "size": "full", "aspectRatio": "1:1",
                    "action": { "type": "uri", "uri": window.sd.l } }] } }
        }]);
    }
    init();
</script>
</body>
</html>
