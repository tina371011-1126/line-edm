<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ—©å®‰åœ–é€£çµå·¥å…·</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line: #06C755; --bg: #f8f9fb; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        
        /* ç•«å¸ƒå€å¡Š */
        .cvs-container { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 16px; overflow: hidden; margin-bottom: 15px; touch-action: none; border: 1px solid #eee; }
        #mc { width: 100%; height: 100%; display: block; }
        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; display: none; z-index: 10; }

        /* è¼¸å…¥æ§åˆ¶ */
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; }
        input[type="color"] { width: 50px; height: 50px; border: none; background: none; cursor: pointer; }

        /* è²¼åœ–é¸å–® */
        .sticker-selector { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; margin-bottom: 15px; }
        .stk-item { font-size: 24px; padding: 8px; background: #f0f0f0; border-radius: 12px; cursor: pointer; border: 2px solid transparent; flex-shrink: 0; }
        .stk-item.active { border-color: var(--line); background: #e8f9ed; }

        /* åŠŸèƒ½æŒ‰éˆ• */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { border: none; padding: 14px; border-radius: 14px; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-primary { background: var(--line); color: white; grid-column: span 2; font-size: 17px; margin-top: 5px; }
        
        /* ç‹€æ…‹æç¤º */
        #statusMsg { color: #d9534f; text-align: center; font-size: 13px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="cvs-container">
        <div id="loadingOverlay">ğŸš€ å½±åƒå„ªåŒ–ä¸­...</div>
        <canvas id="mc" width="800" height="800"></canvas>
    </div>

    <div class="input-row">
        <input type="text" id="userInput" value="æ—©å®‰ï¼Œè¿æ¥ç¾å¥½èƒ½é‡" maxlength="20">
        <input type="color" id="userColor" value="#ffffff">
    </div>

    <div class="sticker-selector">
        <div class="stk-item active" data-val="">ğŸš«</div>
        <div class="stk-item" data-val="â˜€ï¸">â˜€ï¸</div>
        <div class="stk-item" data-val="ğŸŒ¸">ğŸŒ¸</div>
        <div class="stk-item" data-val="â˜•">â˜•</div>
        <div class="stk-item" data-val="ğŸ€">ğŸ€</div>
        <div class="stk-item" data-val="ğŸŒˆ">ğŸŒˆ</div>
    </div>

    <div class="btn-group">
        <button class="btn-secondary" onclick="refreshImage()">ğŸ”„ æ›èƒŒæ™¯</button>
        <button class="btn-secondary" onclick="resetPosition()">ğŸ¯ é‡ç½®æ–‡å­—</button>
        <button class="btn-primary" id="finalShareBtn" onclick="handleShare()">ğŸ“¤ åˆ†äº«çµ¦å¥½å‹ (LIFF)</button>
    </div>

    <div id="statusMsg">âŒ ç¶²è·¯ä¸ç©©å°è‡´ç”¢å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</div>
</div>

<script>
    // é…ç½®å€åŸŸ
    const ACCESS_KEY = "UgZ1pLt9-I5t6BMM71gGBCWZHQk_3oXxYA4uhrHgsVw";
    const LIFF_ID = "2008941488-Phn5v50S";

    const canvas = document.getElementById('mc'), ctx = canvas.getContext('2d');
    let bgImg = new Image();
    let elements = [
        { id: 'text', x: 400, y: 700 },
        { id: 'sticker', x: 700, y: 120, val: '' }
    ];
    let activeEl = null;

    async function initLiff() {
        try { await liff.init({ liffId: LIFF_ID }); } catch(e) {}
        refreshImage();
        document.getElementById('userInput').oninput = drawAll;
        document.getElementById('userColor').oninput = drawAll;
        
        document.querySelectorAll('.stk-item').forEach(el => {
            el.onclick = () => {
                document.querySelectorAll('.stk-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
                elements[1].val = el.dataset.val;
                drawAll();
            };
        });

        setupInteractions();
    }

    function setupInteractions() {
        const start = (e) => {
            const p = getPos(e);
            if(elements[1].val && Math.hypot(p.x-elements[1].x, p.y-elements[1].y) < 80) activeEl = elements[1];
            else if(Math.abs(p.x-elements[0].x) < 300 && Math.abs(p.y-elements[0].y) < 60) activeEl = elements[0];
        };
        const move = (e) => {
            if(!activeEl) return;
            const p = getPos(e); activeEl.x = p.x; activeEl.y = p.y; drawAll();
        };
        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('touchstart', e => { e.preventDefault(); start(e); }, {passive:false});
        window.addEventListener('mousemove', move);
        window.addEventListener('touchmove', e => { if(activeEl) e.preventDefault(); move(e); }, {passive:false});
        window.addEventListener('mouseup', () => activeEl = null);
        window.addEventListener('touchend', () => activeEl = null);
    }

    function getPos(e) {
        const r = canvas.getBoundingClientRect(), t = e.touches ? e.touches[0] : e;
        return { x: (t.clientX - r.left) * (800/r.width), y: (t.clientY - r.top) * (800/r.height) };
    }

    function resetPosition() {
        elements[0].x = 400; elements[0].y = 700;
        elements[1].x = 700; elements[1].y = 120;
        drawAll();
    }

    async function refreshImage() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
            const res = await fetch(`https://api.unsplash.com/photos/random?query=morning,nature&client_id=${ACCESS_KEY}`);
            const data = await res.json();
            bgImg = new Image();
            bgImg.crossOrigin = "anonymous";
            // è£åˆ‡ 40px ä»¥ç§»é™¤æµ®æ°´å°
            bgImg.src = `https://images.weserv.nl/?url=${encodeURIComponent(data.urls.regular)}&w=880&h=880&fit=cover&a=center`;
            bgImg.onload = () => { drawAll(); document.getElementById('loadingOverlay').style.display = 'none'; };
        } catch(e) { 
            document.getElementById('statusMsg').innerText = "ç„¡æ³•å¾ Unsplash æŠ“å–åœ–ç‰‡ï¼Œè«‹æª¢æŸ¥ Keyã€‚";
            document.getElementById('statusMsg').style.display = 'block';
        }
    }

    function drawAll() {
        ctx.drawImage(bgImg, -40, -40, 880, 880);
        
        if(elements[1].val) {
            ctx.font = "120px serif"; ctx.textAlign = "center";
            ctx.fillText(elements[1].val, elements[1].x, elements[1].y);
        }

        const txt = document.getElementById('userInput').value;
        const clr = document.getElementById('userColor').value;
        ctx.font = "bold 52px 'Microsoft JhengHei', sans-serif";
        const w = ctx.measureText(txt).width;
        ctx.fillStyle = "rgba(0,0,0,0.4)";
        ctx.fillRect(elements[0].x - w/2 - 25, elements[0].y - 45, w + 50, 95);
        ctx.fillStyle = clr;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(txt, elements[0].x, elements[0].y + 5);
    }

    async function handleShare() {
        const btn = document.getElementById('finalShareBtn');
        const msg = document.getElementById('statusMsg');
        btn.disabled = true;
        msg.style.display = 'none';
        document.getElementById('loadingOverlay').style.display = 'flex';

        try {
            const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
            const fd = new FormData(); fd.append("file", blob);
            const res = await fetch("https://telegra.ph/upload", { method: "POST", body: fd });
            const d = await res.json();
            
            if(!d[0]) throw new Error("Upload Failed");

            const finalImgUrl = "https://telegra.ph" + d[0].src;
            const liffLink = `line://app/${LIFF_ID}/?i=${encodeURIComponent(finalImgUrl)}&w=800&h=800&f=EDM`;
            
            // é€™è£¡ç›´æ¥å°‡æ–‡æ¡ˆå¯«å…¥åˆ†äº«å…§å®¹
            const shareContent = `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${liffLink}`;

            if (!liff.isLoggedIn()) { liff.login(); return; }

            await liff.shareTargetPicker([{
                "type": "flex",
                "altText": "é€ä½ ä¸€å¼µæ—©å®‰åœ–å¡",
                "contents": {
                    "type": "bubble",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "paddingAll": "0px",
                        "contents": [
                            {
                                "type": "image",
                                "url": finalImgUrl,
                                "size": "full",
                                "aspectRatio": "1:1",
                                "action": {
                                    "type": "uri",
                                    "uri": liffLink
                                }
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "paddingAll": "15px",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": shareContent,
                                        "wrap": true,
                                        "size": "sm",
                                        "color": "#666666"
                                    }
                                ]
                            }
                        ]
                    }
                }
            }]);
        } catch(e) {
            msg.style.display = 'block';
        } finally {
            btn.disabled = false;
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    initLiff();
</script>
</body>
</html>
