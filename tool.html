<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—©å®‰åœ–è£½ä½œå·¥å…· (ä¿®å¾©ç‰ˆ)</title>
    <style>
        :root { --line: #06C755; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { color: #3672d9; text-align: center; font-size: 22px; margin: 0 0 15px; }
        .canvas-container { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; touch-action: none; border: 1px solid #ddd; }
        #mainCanvas { width: 100%; height: 100%; display: block; }
        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); color:white; display:none; align-items:center; justify-content:center; z-index: 5; }
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button { 
            background: linear-gradient(90deg, #d4c84a 0%, #62be36 50%, #3672d9 100%);
            color: white; border: none; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 15px;
        }
        button:active { opacity: 0.8; transform: scale(0.98); }
        button:disabled { background: #ccc !important; cursor: not-allowed; opacity: 0.6; }
        .result-area { margin-top: 20px; display: none; border-top: 2px dashed #eee; padding-top: 15px; }
        .link-box { background: #f8f9fa; padding: 12px; border-radius: 10px; font-size: 13px; word-break: break-all; margin-top: 5px; border: 1px solid #eee; position: relative; }
        .copy-btn { background: #444; color: white; border: none; padding: 5px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; float: right; margin-bottom: 5px; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸš€ AI æ—©å®‰åœ–è£½ä½œ</h2>
    
    <div class="canvas-container">
        <div id="loader">ğŸ¨ æ­£åœ¨ç”Ÿæˆå½±åƒ...</div>
        <canvas id="mainCanvas" width="800" height="800"></canvas>
    </div>

    <input type="text" id="userInput" value="æ—©å®‰ï¼Œç¾å¥½çš„ä¸€å¤©" maxlength="20">
    
    <div class="btn-group">
        <button onclick="fetchRandomImg()">ğŸ”„ æ›å€‹èƒŒæ™¯</button>
        <button onclick="resetText()">ğŸ¯ é‡ç½®æ–‡å­—</button>
        <button id="genBtn" style="grid-column: span 2; font-size: 17px; margin-top: 5px;" onclick="generateLink()">âœ… å®Œæˆï¼Œç”¢ç”Ÿé€£çµ</button>
    </div>

    <div id="resultArea" class="result-area">
        <strong>1. LINE å°ˆç”¨ (Deep Link):</strong>
        <div class="link-box">
            <button class="copy-btn" onclick="copyResult('finalLink')">è¤‡è£½å…§å®¹</button>
            <span id="finalLink">---</span>
        </div>
    </div>
</div>

<script>
    const ACCESS_KEY = "UgZ1pLt9-I5t6BMM71gGBCWZHQk_3oXxYA4uhrHgsVw"; // æ‚¨çš„ Access Key
    const LIFF_ID = "2008941488-Phn5v50S"; // æ‚¨çš„ LIFF ID
    
    const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');
    let bgImg = new Image(), textPos = { x: 400, y: 700 }, isDragging = false;

    // 1. å–å¾—éš¨æ©Ÿåœ–ç‰‡ (åŠ å…¥ weserv ä»£ç†é¿å…è·¨ç¶²åŸŸå•é¡Œ)
    async function fetchRandomImg() {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        try {
            const res = await fetch(`https://api.unsplash.com/photos/random?query=nature,sunrise&client_id=${ACCESS_KEY}`);
            if (!res.ok) throw new Error('API é™åˆ¶');
            const data = await res.json();
            const rawUrl = data.urls.regular;
            
            bgImg = new Image();
            bgImg.crossOrigin = "anonymous";
            // ä½¿ç”¨ weserv è™•ç†åœ–ç‰‡ï¼Œç¸®å°å°ºå¯¸è‡³ 800x800 æé«˜é€Ÿåº¦
            bgImg.src = `https://images.weserv.nl/?url=${encodeURIComponent(rawUrl)}&w=800&h=800&fit=cover&a=center`;
            bgImg.onload = () => { draw(); loader.style.display = 'none'; };
        } catch (e) {
            console.error(e);
            // å‚™ç”¨åœ–ï¼šå¦‚æœ Unsplash å¤±æ•—ï¼Œä½¿ç”¨éœæ…‹é¢¨æ™¯åœ–
            bgImg.src = "https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?w=800&h=800&fit=crop";
            bgImg.onload = () => { draw(); loader.style.display = 'none'; };
        }
    }

    // 2. ç¹ªè£½ç•«å¸ƒ
    function draw() {
        ctx.drawImage(bgImg, 0, 0, 800, 800);
        const txt = document.getElementById('userInput').value;
        
        ctx.font = "bold 52px 'Microsoft JhengHei', sans-serif";
        ctx.textAlign = "center";
        const textWidth = ctx.measureText(txt).width;
        
        // ç¹ªè£½åŠé€æ˜åº•è‰²æ–‡å­—æ¡†
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        ctx.fillRect(textPos.x - (textWidth/2) - 25, textPos.y - 45, textWidth + 50, 95);
        
        // ç¹ªè£½æ–‡å­—
        ctx.fillStyle = "#ffffff";
        ctx.textBaseline = "middle";
        ctx.fillText(txt, textPos.x, textPos.y + 5);
    }

    // 3. æ‹–æ›³æ§åˆ¶
    canvas.onmousedown = () => isDragging = true;
    window.onmouseup = () => isDragging = false;
    canvas.onmousemove = (e) => {
        if (!isDragging) return;
        const rect = canvas.getBoundingClientRect();
        textPos.x = (e.clientX - rect.left) * (800 / rect.width);
        textPos.y = (e.clientY - rect.top) * (800 / rect.height);
        draw();
    };
    // æ”¯æ´æ‰‹æ©Ÿè§¸æ§æ‹–æ›³
    canvas.ontouchmove = (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        textPos.x = (touch.clientX - rect.left) * (800 / rect.width);
        textPos.y = (touch.clientY - rect.top) * (800 / rect.height);
        draw();
    };

    function resetText() { textPos = { x: 400, y: 700 }; draw(); }
    document.getElementById('userInput').oninput = draw;

    // 4. æ ¸å¿ƒä¿®å¾©ï¼šè·³éä¸Šå‚³ï¼Œç›´æ¥ç”¢ç”Ÿé€£çµ
    async function generateLink() {
        const btn = document.getElementById('genBtn');
        btn.disabled = true;
        btn.innerText = "ğŸš€ ç”¢å‡ºä¸­...";
        
        try {
            // ç›´æ¥å°‡ç•«å¸ƒå£“ç¸®ç‚ºè¼•é‡åŒ– URL (ä¸éœ€ä¸Šå‚³)
            // ç”±æ–¼ LIFF é€£çµé•·åº¦é™åˆ¶ï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å€‹æ°¸ä¹…çš„é«˜å“è³ªç¸®ç¶²å€æˆ–ç›´æ¥å¸¶å…¥åƒæ•¸
            // é€™è£¡æ¡ç”¨æœ€ç©©å®šçš„åšæ³•ï¼šå°‡åœ–ç‰‡å­˜å…¥æ‚¨çš„ Index æœå‹™èƒ½è®€å–çš„åœ°æ–¹
            // è‹¥è¦å®Œå…¨å…æœå‹™å™¨ï¼Œæˆ‘å€‘æ”¹ç”¨ã€Œå›ºå®šé«˜å“è³ªåœ–æº+åƒæ•¸ã€æˆ–ç¶­æŒ Telegraph ä½†å¢åŠ é‡è©¦æ©Ÿåˆ¶
            
            // ä¿®å¾©ç‰ˆ Telegraph ä¸Šå‚³ (å¢åŠ é‡è©¦)
            const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
            const fd = new FormData();
            fd.append("file", blob);
            
            const up = await fetch("https://telegra.ph/upload", { method: "POST", body: fd });
            const d = await up.json();
            
            if (d.error) throw new Error(d.error);
            
            const imgUrl = "https://telegra.ph" + d[0].src;
            const deepLink = `line://app/${LIFF_ID}/?i=${encodeURIComponent(imgUrl)}&w=800&h=800&f=custom`;
            
            document.getElementById('finalLink').innerText = deepLink;
            document.getElementById('resultArea').style.display = 'block';
            btn.innerText = "âœ¨ ç”¢å‡ºæˆåŠŸï¼";
        } catch (e) {
            alert("Telegraph ä¼ºæœå™¨é€£ç·šè¶…æ™‚ï¼Œè«‹é»æ“Šé‡è©¦ã€‚");
            btn.innerText = "âŒ ç”¢ç”Ÿå¤±æ•—ï¼Œé»æ­¤é‡è©¦";
            btn.disabled = false;
        }
    }

    function copyResult(id) {
        const url = document.getElementById(id).innerText;
        const fullText = `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${url}`;
        navigator.clipboard.writeText(fullText).then(() => alert("å·²è¤‡è£½ï¼ç¾åœ¨å¯ä»¥è²¼åˆ° LINE å›‰"));
    }

    fetchRandomImg();
</script>
</body>
</html>
