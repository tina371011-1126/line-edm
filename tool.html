<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDM é€£çµç”¢ç”Ÿå™¨ v5.1</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 380px; }
        
        /* æ¨™é¡Œé¡è‰²é…åˆæ–°æ¼¸å±¤çš„è—è‰²ç«¯ */
        h2 { color: #3672d9; text-align: center; font-size: 20px; margin-bottom: 5px; }
        
        p { font-size: 12px; color: #777; text-align: center; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* ä¿®æ”¹é»ï¼šä¸»è¦æŒ‰éˆ•å¥—ç”¨æ–°çš„é®®è±”æ¼¸å±¤ */
        button { 
            background: linear-gradient(90deg, #addd35 0%, #3672d9 100%);
            color: white; 
            border: none; 
            padding: 14px; 
            border-radius: 8px; 
            width: 100%; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 5px; 
            font-size: 16px; 
            box-shadow: 0 4px 10px rgba(54, 114, 217, 0.3);
            transition: opacity 0.3s, transform 0.1s;
        }
        button:hover { opacity: 0.9; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        .result-area { margin-top: 20px; display: none; }
        .link-label { font-size: 12px; font-weight: bold; color: #555; margin-top: 15px; display: block; }
        .link-box { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; word-break: break-all; font-size: 13px; font-family: monospace; position: relative; margin-top: 5px; line-height: 1.5; }
        
        /* ä¿®æ”¹é»ï¼šè¤‡è£½å°æŒ‰éˆ•ä¹ŸåŒæ­¥å¥—ç”¨æ¼¸å±¤ */
        .copy-btn { 
            background: linear-gradient(90deg, #addd35 0%, #3672d9 100%);
            color: white; 
            border: none; 
            padding: 5px 12px;
            border-radius: 20px; 
            font-size: 11px; 
            cursor: pointer; 
            float: right; 
            margin-bottom: 5px; 
            width: auto; 
            margin-top: 0;
            box-shadow: none;
        }

        .preview-text { color: #3672d9; font-weight: bold; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸš€ EDM é€£çµç”¢ç”Ÿå™¨</h2>
    <p>ç”¢å‡ºå·²åŒ…å«è½‰å‚³è¿½è¹¤èˆ‡è‡ªå‹•æ›è¡Œ</p>
    <input type="url" id="imgUrl" placeholder="è«‹è²¼ä¸Šåœ–ç‰‡ç¶²å€">
    <button id="genBtn" onclick="generate()">ç”¢ç”Ÿé€£çµ</button>
    <div id="resultArea" class="result-area">
        <span class="link-label">1. LINE å°ˆç”¨ (å¼·åˆ¶å–šå›):</span>
        <div class="link-box">
            <button class="copy-btn" onclick="copyText('deepLink')">è¤‡è£½å…§å®¹</button>
            <span class="preview-text">ğŸ””æ‰“é–‹EDMé€£çµï¼š</span><br>
            <span id="deepLink">---</span>
        </div>
        <span class="link-label">2. è¬ç”¨çŸ­ç¶²å€ (å¤–éƒ¨ä½¿ç”¨):</span>
        <div class="link-box">
            <button class="copy-btn" onclick="copyText('shortLink')">è¤‡è£½å…§å®¹</button>
            <span class="preview-text">ğŸ””æ‰“é–‹EDMé€£çµï¼š</span><br>
            <span id="shortLink">---</span>
        </div>
    </div>
</div>
<script>
    const LIFF_ID = "2008941488-Phn5v50S";
    const PROXY = 'https://corsproxy.io/?';
    async function generate() {
        const rawImgUrl = document.getElementById('imgUrl').value.trim();
        if(!rawImgUrl) return alert("è«‹è¼¸å…¥ç¶²å€");
        
        // ç°¡å–®é©—è­‰ç¶²å€æ ¼å¼
        if (!rawImgUrl.startsWith('http')) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ http/https ç¶²å€");

        const btn = document.getElementById('genBtn');
        btn.disabled = true; btn.innerText = "è™•ç†ä¸­...";
        try {
            // 1. å˜—è©¦ç²å–åœ–ç‰‡å°ºå¯¸ (é€™ä¹Ÿæœƒé †ä¾¿é©—è­‰åœ–ç‰‡æ˜¯å¦å¯å­˜å–)
            const dims = await getImageDimensions(rawImgUrl);
            
            // 2. ç¸®çŸ­åŸå§‹åœ–ç‰‡ç¶²å€
            btn.innerText = "ç¸®çŸ­ç¶²å€ä¸­...";
            const shortImgUrl = await getShortUrl(rawImgUrl);
            
            // 3. çµ„åˆ LIFF é€£çµ
            const liffBase = `https://liff.line.me/${LIFF_ID}/?i=${encodeURIComponent(shortImgUrl)}&w=${dims.w}&h=${dims.h}&f=d`;
            const deepLink = `line://app/${LIFF_ID}/?i=${encodeURIComponent(shortImgUrl)}&w=${dims.w}&h=${dims.h}&f=d`;
            
            // 4. ç¸®çŸ­æœ€çµ‚ LIFF é€£çµ
            const finalShort = await getShortUrl(liffBase);
            
            document.getElementById('deepLink').innerText = deepLink;
            document.getElementById('shortLink').innerText = finalShort;
            document.getElementById('resultArea').style.display = 'block';
        } catch (e) { 
            console.error(e);
            alert("ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€æ˜¯å¦æ­£ç¢ºä¸”å¯å…¬é–‹å­˜å–ã€‚"); 
        } finally { 
            btn.disabled = false; btn.innerText = "ç”¢ç”Ÿé€£çµ"; 
        }
    }
    async function getShortUrl(longUrl) {
        try {
            const api = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`;
            const response = await fetch(PROXY + encodeURIComponent(api));
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            return data.shorturl || longUrl;
        } catch (e) { 
            console.warn("Shorten failed, using long URL", e);
            return longUrl; 
        }
    }
    function getImageDimensions(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve({w: img.width, h: img.height});
            img.onerror = () => {
                // åœ–ç‰‡è®€å–å¤±æ•—æ™‚ï¼Œçµ¦äºˆæç¤ºä¸¦ä½¿ç”¨é è¨­æ¯”ä¾‹
                alert("è­¦å‘Šï¼šç„¡æ³•è®€å–åœ–ç‰‡å°ºå¯¸ï¼Œå¯èƒ½å°è‡´é è¦½æ¯”ä¾‹ä¸æ­£ç¢ºã€‚\nå»ºè­°ç¢ºèªåœ–ç‰‡ç¶²å€æ˜¯å¦å…è¨±è·¨åŸŸå­˜å–(CORS)ã€‚");
                resolve({w: 800, h: 800}); // ä½¿ç”¨æ­£æ–¹å½¢ä½œç‚º fallback
            };
            // è¨­å®š crossOrigin ä»¥å˜—è©¦è§£æ±ºè·¨åŸŸå•é¡Œ
            img.crossOrigin = "Anonymous";
            img.src = url;
        });
    }
    function copyText(id) {
        const url = document.getElementById(id).innerText;
        const fullText = `ğŸ””æ‰“é–‹EDMé€£çµï¼š\n${url}`;
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
             navigator.clipboard.writeText(fullText)
                .then(() => alert("å·²è¤‡è£½ï¼"))
                .catch(err => fallbackCopy(fullText));
        } else {
            fallbackCopy(fullText);
        }
    }
    
    function fallbackCopy(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert("å·²è¤‡è£½ï¼(ä½¿ç”¨å‚™ç”¨å‰ªè²¼ç°¿)");
        } catch (err) {
            alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚");
        }
        document.body.removeChild(textArea);
    }
</script>
</body>
</html>
