<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDM é€£çµç”¢ç”Ÿå™¨ - ç›´æ¥åˆ†äº«ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 380px; }
        h2 { color: #3672d9; text-align: center; font-size: 20px; margin-bottom: 5px; }
        p { font-size: 12px; color: #777; text-align: center; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* æ¼¸å±¤æŒ‰éˆ• */
        button { 
            background: linear-gradient(90deg, #d4c84a 0%, #62be36 50%, #3672d9 100%);
            color: white; border: none; padding: 14px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 16px; box-shadow: 0 4px 10px rgba(54, 114, 217, 0.3); transition: 0.3s; 
        }
        button:hover { opacity: 0.9; transform: scale(0.98); }
        button:disabled { background: #ccc !important; cursor: not-allowed; box-shadow: none; }
        
        /* åˆ†äº«æŒ‰éˆ•ç‰¹åˆ¥æ¨£å¼ */
        .share-btn { background: #06C755; margin-top: 15px; display: none; } /* LINE ç¶  */

        .result-area { margin-top: 20px; display: none; }
        .link-label { font-size: 12px; font-weight: bold; color: #555; margin-top: 15px; display: block; }
        .link-box { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; word-break: break-all; font-size: 13px; font-family: monospace; position: relative; margin-top: 5px; line-height: 1.5; }
        
        .copy-btn { background: #666; color: white; border: none; padding: 5px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; float: right; margin-bottom: 5px; width: auto; margin-top: 0; box-shadow: none; }
        
        #liffMsg { font-size: 11px; color: #e74c3c; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸš€ EDM æ¥µé€Ÿåˆ†äº«å™¨</h2>
    <p>è¼¸å…¥ç¶²å€å¾Œç›´æ¥ç™¼é€åœ–å¡åˆ°ç¾¤çµ„</p>
    
    <input type="url" id="imgUrl" placeholder="è«‹è²¼ä¸Šåœ–ç‰‡ç¶²å€">
    <button id="genBtn" onclick="generate()">1. ç”¢ç”Ÿé è¦½èˆ‡é€£çµ</button>

    <div id="resultArea" class="result-area">
        <button id="shareBtn" class="share-btn" onclick="directShare()">ç›´æ¥ç™¼é€åˆ° LINE ç¾¤çµ„/å¥½å‹</button>
        <div id="liffMsg"></div>

        <span class="link-label">å‚™ç”¨ï¼šæ‰‹å‹•è¤‡è£½é€£çµ</span>
        <div class="link-box">
            <button class="copy-btn" onclick="copyText()">è¤‡è£½</button>
            <span id="finalLink">---</span>
        </div>
    </div>
</div>

<script>
    const LIFF_ID = "2008941488-Phn5v50S";
    const PROXY = 'https://corsproxy.io/?';
    let currentData = { url: "", w: 800, h: 800, liffUrl: "" };

    // åˆå§‹åŒ– LIFF
    async function initToolLIFF() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                // å¦‚æœåœ¨å¤–éƒ¨ç€è¦½å™¨é–‹å•Ÿï¼Œæç¤ºç™»å…¥
                document.getElementById('liffMsg').innerText = "æç¤ºï¼šç™»å…¥ LINE å¾Œå¯ä½¿ç”¨ç›´æ¥åˆ†äº«åŠŸèƒ½";
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function generate() {
        const rawImgUrl = document.getElementById('imgUrl').value.trim();
        if(!rawImgUrl) return alert("è«‹è¼¸å…¥ç¶²å€");
        
        const btn = document.getElementById('genBtn');
        btn.disabled = true; btn.innerText = "è®€å–åœ–ç‰‡è³‡è¨Šä¸­...";

        try {
            const shortImgUrl = await getShortUrl(rawImgUrl);
            const dims = await getImageDimensions(rawImgUrl);
            const liffUrl = `https://liff.me/${LIFF_ID}/?i=${encodeURIComponent(shortImgUrl)}&w=${dims.w}&h=${dims.h}&f=Tool`;

            currentData = { url: shortImgUrl, w: dims.w, h: dims.h, liffUrl: liffUrl };

            document.getElementById('finalLink').innerText = liffUrl;
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('shareBtn').style.display = 'block';
            
            btn.innerText = "ç”¢ç”ŸæˆåŠŸï¼";
        } catch (e) {
            alert("ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€");
        } finally {
            btn.disabled = false;
            setTimeout(() => { btn.innerText = "1. ç”¢ç”Ÿé è¦½èˆ‡é€£çµ"; }, 2000);
        }
    }

    async function directShare() {
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        if (!liff.isApiAvailable('shareTargetPicker')) {
            alert("æ­¤ç’°å¢ƒä¸æ”¯æ´åˆ†äº«åŠŸèƒ½ï¼Œè«‹åœ¨ LINE å…§ä½¿ç”¨");
            return;
        }

        try {
            const res = await liff.shareTargetPicker([{
                "type": "flex",
                "altText": "æ‚¨æ”¶åˆ°ä¸€å¼µ EDM åœ–ç‰‡åˆ†äº«",
                "contents": {
                    "type": "bubble",
                    "size": "mega",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "paddingAll": "0px",
                        "contents": [{
                            "type": "image",
                            "url": currentData.url,
                            "size": "full",
                            "aspectMode": "fit",
                            "aspectRatio": `${currentData.w}:${currentData.h}`,
                            "action": { "type": "uri", "uri": currentData.liffUrl }
                        }]
                    }
                }
            }]);

            if (res) {
                alert("å·²æˆåŠŸç™¼é€è‡³èŠå¤©å®¤ï¼");
            }
        } catch (error) {
            alert("åˆ†äº«å–æ¶ˆæˆ–å¤±æ•—");
        }
    }

    // è¼”åŠ©å‡½å¼
    async function getShortUrl(longUrl) {
        try {
            const api = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`;
            const response = await fetch(PROXY + encodeURIComponent(api));
            const data = await response.json();
            return data.shorturl || longUrl;
        } catch (e) { return longUrl; }
    }

    function getImageDimensions(url) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve({w: img.width, h: img.height});
            img.onerror = () => resolve({w: 800, h: 800});
            img.src = url;
        });
    }

    function copyText() {
        const url = document.getElementById('finalLink').innerText;
        navigator.clipboard.writeText(url).then(() => alert("å·²è¤‡è£½é€£çµ"));
    }

    initToolLIFF();
</script>
</body>
</html>
